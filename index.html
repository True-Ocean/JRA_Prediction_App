<!DOCTYPE html>
<html lang="ja">
<head>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TEDXL8L716"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-TEDXL8L716');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta property="og:url" content="https://true-ocean.github.io/JRA_Prediction_App/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ğŸ äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³ï¼">
    <meta property="og:description" content="å¥½ããªè¨€è‘‰ã‚’ç¨®ã«ã—ã¦ã€ã‚ãªãŸã ã‘ã®é¦¬ã‚’é¸ã¼ã†ï¼">
    <meta property="og:image" content="https://true-ocean.github.io/JRA_Prediction_App/app_image.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ğŸ äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³ï¼">
    <meta name="twitter:description" content="å¥½ããªè¨€è‘‰ã‚’ç¨®ã«ã—ã¦ã€ã‚ãªãŸã ã‘ã®é¦¬ã‚’é¸ã¼ã†ï¼">
    <meta name="twitter:image" content="https://true-ocean.github.io/JRA_Prediction_App/app_image.png">

    <title>ğŸ äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³ï¼</title>
    <style>
        :root {
            --theme-color: #27ae60;
            --theme-hover: #219150;
            --accent-color: #27ae60;
            --reset-color: #95a5a6;
            --copy-color: #34495e;
        }
        
        /* ãƒãƒŠãƒ¼è¨­å®š */
        .top-banner {
            background: var(--theme-color);
            color: white;
            text-align: center;
            padding: 15px 10px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* bodyã®èƒŒæ™¯ã‚’ç”»åƒã«å¤‰æ›´ */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-image: url('app_image.png');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: #333;
            padding: 0;
            margin: 0;
            transition: 0.3s;
            background-repeat: no-repeat;
            min-height: 100vh;
        }

        /* ä¸­å¤®ã®ç™½ã„ãƒ‘ãƒãƒ«ã‚’åŠé€æ˜ã«ã™ã‚‹ */
        .container {
            background: rgba(255, 255, 255, 0.5); /* æœ€å¾ŒãŒé€æ˜åº¦ã€‚å¾Œã‚ã‚’é€ã‹ã—ã¾ã™ */
            backdrop-filter: blur(8px); /* èƒŒå¾Œã‚’ã¼ã‹ã™ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆiOSãªã©ã§ç¶ºéº—ã«è¦‹ãˆã¾ã™ï¼‰ */
            -webkit-backdrop-filter: blur(8px);
            max-width: 600px;
            margin: 15px auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* ãƒãƒŠãƒ¼ã‚‚å°‘ã—é€éã•ã›ã‚‹ */
        .top-banner {
            background: var(--theme-color);
            opacity: 0.95;
            color: white;
            text-align: center;
            padding: 15px 10px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 { text-align: center; color: #2c3e50; border-bottom: 2px solid var(--theme-color); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; transition: 0.3s; }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; align-items: stretch;}
        label { font-weight: bold; margin-bottom: 5px; font-size: 0.85em; color: #555; text-align: left;}
        select, input { padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; background: #fff; width: 100%; 
            box-sizing: border-box; -webkit-appearance: none; appearance: none; display: block; text-align: left; text-align-last: left; }
        
        /* iOSã®æ—¥ä»˜å…¥åŠ›æ¬„ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚„ä¸­èº«ã‚’å·¦å¯„ã›ã«ã™ã‚‹ãŸã‚ã®å‘ªæ–‡ */
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            right: 10px;
        }
        input[type="date"] {
            position: relative;
        }

        /* ç„¡åŠ¹åŒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        select:disabled, input:disabled {
            background-color: #f0f0f0;
            color: #999;
            cursor: not-allowed;
            border-color: #ddd;
            opacity: 1;
            -webkit-text-fill-color: #999;
        }
        
        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚¹ãƒãƒ›ã§ã‚‚2åˆ—ã‚’ç¶­æŒã™ã‚‹ã‚¯ãƒ©ã‚¹ï¼‰ */
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 5px; }

        .word-inputs { display: flex; flex-direction: column; gap: 8px; width: 100%; }

        /* ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .button-stack { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        button { width: 100%; padding: 15px; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; box-sizing: border-box; }
        
        .btn-predict { background: var(--theme-color); font-size: 18px; }
        .btn-predict:hover { opacity: 0.9; }
        .btn-reset { background: var(--reset-color); }
        .btn-copy { background: var(--copy-color); display: none; }
        button:active { transform: scale(0.98); }

        /* çµæœè¡¨ç¤º */
        #result { margin-top: 25px; }
        .prediction-card { border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow: hidden; }

        .prediction-item { 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            padding: 10px 12px; 
            border-bottom: 1px solid #eee;
            min-width: 320px;
            box-sizing: border-box;
        }

        .prediction-item:last-child { border-bottom: none; }
        .mark { width: 30px; font-weight: bold; font-size: 1.2em; text-align: center; flex-shrink: 0; }
        .waku-box { width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; margin-left: 10px; flex-shrink: 0; }
        .horse-name { font-weight: bold; font-size: 1em; color: #2c3e50; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .horse-info { margin-left: 10px; display: flex; flex-direction: column; min-width: 0; flex: 1;}
        .jockey-name { font-size: 0.8em; color: #666; margin-top: 2px; }
                
        #errorMessage {
            text-align: center;
            white-space: pre-line;
            font-size: 0.9em;
            opacity: 0;
            max-height: 0;
            margin-bottom: 0;
            padding: 0;
            visibility: hidden;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        #errorMessage.show {
            opacity: 1;
            max-height: 100px;
            margin-bottom: 15px;
            padding: 12px;
            visibility: visible;
            background-color: #e74c3c;
            color: #fff;
            border-radius: 8px;
            border: 1px solid #c0392b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<body>

<div class="top-banner" id="topBanner">
    ğŸ‡ äºˆæƒ³ã®ç¨®ã‚’è’”ã„ã¦ç°¡å˜ãŠé¦¬é¸ã³ï¼ğŸ‡
</div>

<div class="container">

    <h1 id="mainTitle">ğŸ‡ æ±ç”¨ãƒ¢ãƒ¼ãƒ‰ ğŸ‡</h1>
    
    <p id="genericWarning" style="text-align: center; font-size: 0.8em; color: #666; line-height: 1.6; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 6px; border-left: 4px solid var(--theme-color);">
        ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã‚’é¸æŠã—ã¦ã€äºˆæƒ³ã®ç¨®ã‚’è’”ã„ã¦ã­ï¼<br>
        âš ï¸ çµæœã¯é¦¬ç•ªã®ã¿ã§ã€é¦¬åã¯å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“
    </p>

    <div class="form-group">
        <label>ãƒ¬ãƒ¼ã‚¹é¸æŠ</label>
        <select id="raceSelector" onchange="applySelectedRace()">
            <option value="-1">è‡ªåˆ†ã§ãƒ¬ãƒ¼ã‚¹æ¡ä»¶é¸æŠ</option>
        </select>
    </div>

    <div class="row">
        <div class="form-group">
            <label>é–‹å‚¬æ—¥</label>
            <input type="date" id="raceDate" onchange="checkRaceMode()">
        </div>
        <div class="form-group"><label>ã‚¯ãƒ©ã‚¹</label>
            <select id="raceClass" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option selected>G1</option><option>G2</option><option>G3</option><option>OP(L)</option>
                <option>ã‚ªãƒ¼ãƒ—ãƒ³</option><option>3å‹ã‚¯ãƒ©ã‚¹</option><option>2å‹ã‚¯ãƒ©ã‚¹</option>
                <option>1å‹ã‚¯ãƒ©ã‚¹</option><option>æœªå‹åˆ©</option><option>æ–°é¦¬</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group">
            <label>ç«¶é¦¬å ´</label>
            <select id="venue" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option>æœ­å¹Œ</option><option>å‡½é¤¨</option><option>æ–°æ½Ÿ</option><option>ç¦å³¶</option>
                <option selected>æ±äº¬</option><option>ä¸­å±±</option><option>ä¸­äº¬</option><option>äº¬éƒ½</option>
                <option>é˜ªç¥</option><option>å°å€‰</option>
            </select>
        </div>
        <div class="form-group"><label>ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
            <select id="raceNum" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <script>for(let i=1;i<=12;i++){ const sel = (i===11?'selected':''); document.write(`<option value="${i}R" ${sel}>${i}R</option>`); }</script>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group"><label>å¹´é½¢é™å®š</label>
            <select id="ageLimit" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option>2æ­³</option><option>3æ­³</option><option>3æ­³ä»¥ä¸Š</option><option selected>4æ­³ä»¥ä¸Š</option>
            </select>
        </div>
        <div class="form-group"><label>é‡é‡</label>
            <select id="weightType" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option selected>å®šé‡</option><option>åˆ¥å®š</option><option>é¦¬é½¢</option><option>ãƒãƒ³ãƒ‡</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group"><label>ãƒˆãƒ©ãƒƒã‚¯</label>
            <select id="track" onchange="updateTheme(); checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option value="èŠ">èŠ</option>
                <option value="ãƒ€ãƒ¼ãƒˆ" selected>ãƒ€ãƒ¼ãƒˆ</option>
            </select>
        </div>
        <div class="form-group"><label>è·é›¢</label>
            <select id="distance" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <script>
                    const dists = ['1000','1150','1200','1300','1400','1500','1600','1700','1800','1900','2000','2100','2200','2300','2400','2500','2600','3000','3200','3400','3600'];
                    dists.forEach(d => {
                        const sel = (d === '1600' ? 'selected' : '');
                        document.write(`<option value="${d}" ${sel}>${d}m</option>`);
                    });
                </script>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group">
            <label>å‡ºèµ°é ­æ•°</label>
            <select id="horseCount" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <script>
                    for(let i=5; i<=18; i++) {
                        const selected = i === 16 ? 'selected' : '';
                        document.write(`<option value="${i}" ${selected}>${i}é ­</option>`);
                    }
                </script>
            </select>
        </div>
        <div class="form-group"><label>é¦¬å ´çŠ¶æ…‹</label>
            <select id="condition" onchange="validateInputs()">
                <option value="" selected>-- é¸æŠ --</option>
                <option>è‰¯</option><option>ç¨é‡</option><option>é‡</option><option>ä¸è‰¯</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>äºˆæƒ³ã®ç¨®ï¼ˆå¥½ããªè¨€è‘‰ãªã©ã‚’3ã¤ã¾ã§ï¼‰</label>
        <div class="word-inputs">
            <input type="text" id="word1" placeholder="ç¨®1" oninput="validateInputs()">
            <input type="text" id="word2" placeholder="ç¨®2" oninput="validateInputs()">
            <input type="text" id="word3" placeholder="ç¨®3" oninput="validateInputs()">
        </div>
    </div>

    <div id="errorMessage"></div>

    <div class="button-stack">
        <button class="btn-predict" onclick="generatePrediction()">äºˆæƒ³ã®ç¨®ã‚’è’”ãï¼</button>
        <button class="btn-reset" id="resetBtn" onclick="resetToDefault()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="result"></div>

    <div class="button-stack">
        <button class="btn-save" id="saveBtn" onclick="saveAsImage()" style="background: #FF77FF; display: none;">çµæœã‚’ç”»åƒã§ä¿å­˜ãƒ»å…±æœ‰</button>
        <button class="btn-x" id="xBtn" onclick="postToX()" style="background: #000; display: none;">çµæœã‚’ X ã«ãƒã‚¹ãƒˆï¼ˆç”»åƒãªã—ï¼‰</button>
        <button class="btn-copy" id="copyBtn" onclick="copyResult()">çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
    </div>

    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 0.7em; line-height: 1.5;">
        <p style="margin-bottom: 10px;">
            Disclaimer: This application is for entertainment purposes only. It does not provide financial or betting advice. Users are responsible for their own decisions.<br>
            å…è²¬äº‹é …ï¼šæœ¬ã‚¢ãƒ—ãƒªã¯ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€é‡‘èã¾ãŸã¯å‹é¦¬æŠ•ç¥¨ï¼ˆè³­åšï¼‰ã«é–¢ã™ã‚‹åŠ©è¨€ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åˆ©ç”¨è€…ã¯è‡ªå·±ã®è²¬ä»»ã«ãŠã„ã¦æœ¬ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
        </p>
        <p style="text-align: center; font-weight: bold;">
            Created by <a href="#" style="color: #666; text-decoration: none;">ã‚·ãƒ£ãƒãƒ¯ãƒ¼ãƒ«</a>. All rights reserved.
        </p>
    </footer>

</div>

<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center; flex-direction:column; padding: 20px;">
    <p style="color:white; margin-bottom:15px; font-weight:bold; text-align:center;">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦<br>ã€Œ"å†™çœŸ"ã«ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <img id="previewImage" style="max-width:100%; max-height:70%; border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
    <button onclick="document.getElementById('imageModal').style.display='none'" style="margin-top:25px; background:#fff; color:#333; width:auto; padding:12px 40px; border-radius:30px;">é–‰ã˜ã‚‹</button>
</div>

<script>
// ==========================================
// ã€ãƒ¬ãƒ¼ã‚¹è¨­å®šãƒªã‚¹ãƒˆã€‘
// ==========================================
const RACE_LIST = [
    {
        raceDate: "2026-02-22",
        title: "ãƒ•ã‚§ãƒ–ãƒ©ãƒªãƒ¼S",
        venue: "æ±äº¬",
        raceNum: "11R",
        track: "ãƒ€ãƒ¼ãƒˆ",
        distance: "1600",
        ageLimit: "4æ­³ä»¥ä¸Š",
        raceClass: "G1",
        weightType: "å®šé‡",
        horseCount: 16,
        horses: [
            { name: "ã‚ªãƒ¡ã‚¬ã‚®ãƒã‚¹", info: "ç‰¡6", jockey: "å²©ç”°åº·èª " },
            { name: "ãƒãƒƒãƒ”ãƒ¼ãƒãƒ³", info: "ç‰¡4", jockey: "é«˜æ‰åéº’" },
            { name: "ãƒ–ãƒ©ã‚¤ã‚¢ãƒ³ã‚»ãƒ³ã‚¹", info: "ç‰¡6", jockey: "å²©ç”°æœ›æ¥" },
            { name: "ãƒšãƒªã‚¨ãƒ¼ãƒ«", info: "ç‰¡6", jockey: "ä½ã€…æœ¨å¤§" },
            { name: "ã‚·ãƒƒã‚¯ã‚¹ãƒšãƒ³ã‚¹", info: "ç‰¡5", jockey: "æˆ¸å´åœ­å¤ª" },
            { name: "ãƒ©ãƒ ã‚¸ã‚§ãƒƒãƒˆ", info: "ç‰¡5", jockey: "ä¸‰æµ¦çš‡æˆ" },
            { name: "ãƒ­ãƒ³ã‚°ãƒ©ãƒ³", info: "ã‚»8", jockey: "è»é‡æ¥µ" },
            { name: "ã‚µã‚¯ãƒ©ãƒˆã‚¥ã‚¸ãƒ¥ãƒ¼ãƒ«", info: "ã‚»9", jockey: "ã‚­ãƒ³ã‚°" },
            { name: "ãƒ€ãƒ–ãƒ«ãƒãƒ¼ãƒˆãƒœãƒ³ãƒ‰", info: "ç‰5", jockey: "å‚äº•ç‘ æ˜Ÿ" },
            { name: "ãƒ­ãƒ¼ãƒ‰ã‚¯ãƒ­ãƒ³ãƒŒ", info: "ç‰¡5", jockey: "æ©«å±±å’Œç”Ÿ" },
            { name: "ã‚µãƒ³ãƒ©ã‚¤ã‚ºãƒ›ãƒ¼ã‚¯", info: "ã‚»7", jockey: "æ¾å²¡æ­£æµ·" },
            { name: "ã‚³ã‚¹ã‚¿ãƒãƒ´ã‚¡", info: "ç‰¡6", jockey: "ãƒ«ãƒ¡ãƒ¼ãƒ«" },
            { name: "ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒ©ã‚¤ã‚º", info: "ç‰¡4", jockey: "æ©«å±±æ­¦å²" },
            { name: "ã‚¦ã‚£ãƒ«ã‚½ãƒ³ãƒ†ã‚½ãƒ¼ãƒ­", info: "ç‰¡7", jockey: "å·ç”°å°†é›…" },
            { name: "ãƒšãƒ—ãƒãƒ‰ãƒŠã‚¤ãƒ«", info: "ç‰¡8", jockey: "å¯Œç”°æš" },
            { name: "ã‚µã‚¤ãƒ¢ãƒ³ã‚¶ãƒŠãƒ‰ã‚¥", info: "ç‰¡6", jockey: "æ± æ·»è¬™ä¸€" }
        ]
    },
    {
        raceDate: "2026-02-22",
        title: "å°å€‰å¤§è³å…¸",
        venue: "å°å€‰",
        raceNum: "11R",
        track: "èŠ",
        distance: "1800",
        ageLimit: "4æ­³ä»¥ä¸Š",
        raceClass: "G3",
        weightType: "ãƒãƒ³ãƒ‡",
        horseCount: 16,
        horses: [
            { name: "ãƒãƒ†ãƒ³ãƒ­ã‚¦ã‚ªãƒªã‚ªãƒ³", info: "ç‰¡7", jockey: "æ©«å±±å…¸å¼˜" },
            { name: "ãƒ“ãƒ¼ã‚¢ã‚¹ãƒˆãƒ‹ãƒƒã‚·ãƒ‰", info: "ç‰¡7", jockey: "è¥¿æ‘å¤ªä¸€" },
            { name: "ã‚¨ã‚¢ãƒ•ã‚¡ãƒ³ãƒ‡ã‚£ã‚¿", info: "ã‚»9", jockey: "äº€ç”°æ¸©å¿ƒ" },
            { name: "ã‚·ãƒ§ã‚¦ãƒŠãƒ³ã‚¢ãƒ‡ã‚¤ãƒ–", info: "ç‰¡7", jockey: "ä¸¸å±±å…ƒæ°—" },
            { name: "ãƒ˜ãƒªã‚ªã‚¹", info: "ã‚»10", jockey: "èŠæ²¢ä¸€æ¨¹" },
            { name: "ãƒãƒ¬ãƒ", info: "ç‰5", jockey: "é®«å³¶å…‹é§¿" },
            { name: "ã‚·ãƒ«ãƒˆãƒ›ãƒ«ãƒ³", info: "ç‰¡6", jockey: "çŸ³ç”°æ‹“éƒ" },
            { name: "ãƒ©ã‚±ãƒ¼ãƒãƒ€", info: "ç‰¡6", jockey: "ä¸¹å†…ç¥æ¬¡" },
            { name: "ãƒŠãƒ ãƒ©ã‚¨ã‚¤ãƒãƒ–", info: "ç‰¡5", jockey: "å‰ç”°éš¼äºº" },
            { name: "ã‚±ã‚¤ã‚¢ã‚¤ã‚»ãƒŠ", info: "ç‰¡7", jockey: "è—¤å²¡ä½‘ä»‹" },
            { name: "ã‚¨ãƒ”ãƒ•ã‚¡ãƒ‹ãƒ¼", info: "ç‰¡7", jockey: "æ‰åŸèª äºº" },
            { name: "ã‚»ãƒ³ãƒ„ãƒ–ãƒ©ã‚¤ãƒˆ", info: "ç‰¡4", jockey: "å›£é‡å¤§æˆ" },
            { name: "ã‚¬ã‚¤ã‚¢ãƒ¡ãƒ³ãƒ†", info: "ç‰¡5", jockey: "åŒ—æ‘å‹ä¸€" },
            { name: "ã‚¨ãƒ©ãƒˆãƒ¼", info: "ç‰5", jockey: "æ–è—¤æ–°" },
            { name: "ãƒªã‚«ãƒ³ã‚«ãƒ–ãƒ¼ãƒ«", info: "ã‚»7", jockey: "æµœä¸­ä¿Š" },
            { name: "ã‚¿ã‚¬ãƒãƒ‡ãƒ¥ãƒ¼ãƒ‰", info: "ç‰¡5", jockey: "å¤å·å‰æ´‹" }
        ]
    }
];

let isRace = false;
let currentActiveRace = null;
let currentPredictionText = "";

window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('raceDate').value = today;

    const selector = document.getElementById('raceSelector');
    RACE_LIST.forEach((race, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.innerText = race.title;
        selector.appendChild(opt);
    });

    selector.value = "-1";
    applySelectedRace("-1");
};

function toggleInputsDisabled(isDisabled) {
    const targetIds = [
        'raceDate', 'venue', 'raceNum', 'ageLimit', 
        'raceClass', 'track', 'distance', 'weightType', 'horseCount'
    ];
    targetIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = isDisabled;
    });
}

function applySelectedRace(forcedIndex = null) {
    const selector = document.getElementById('raceSelector');
    const index = forcedIndex !== null ? forcedIndex : selector.value;
    const errorEl = document.getElementById('errorMessage');
    if (errorEl) errorEl.classList.remove('show');

    if (index === "-1") {
        toggleInputsDisabled(false);
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('raceDate').value = today;
        document.getElementById('venue').value = "";
        document.getElementById('raceNum').value = "";
        document.getElementById('ageLimit').value = "";
        document.getElementById('raceClass').value = "";
        document.getElementById('track').value = "";
        document.getElementById('distance').value = "";
        document.getElementById('weightType').value = "";
        document.getElementById('condition').value = "";
        document.getElementById('horseCount').value = "";
        document.getElementById('word1').value = "";
        document.getElementById('word2').value = "";
        document.getElementById('word3').value = "";
        updateTheme();
        checkRaceMode();
        return;
    }
    
    toggleInputsDisabled(true);
    const race = RACE_LIST[index];
    document.getElementById('raceDate').value = race.raceDate;
    document.getElementById('venue').value = race.venue;
    document.getElementById('raceNum').value = race.raceNum;
    document.getElementById('ageLimit').value = race.ageLimit;
    document.getElementById('raceClass').value = race.raceClass;
    document.getElementById('track').value = race.track;
    document.getElementById('distance').value = race.distance;
    document.getElementById('weightType').value = race.weightType;
    document.getElementById('condition').value = "";
    document.getElementById('horseCount').value = race.horseCount;
    document.getElementById('word1').value = "";
    document.getElementById('word2').value = "";
    document.getElementById('word3').value = "";
    updateTheme();
    checkRaceMode();
    document.getElementById('resetBtn').innerText = `ãƒªã‚»ãƒƒãƒˆï¼ˆ${race.title}ï¼‰`;
}

function checkRaceMode() {
    const raceSelector = document.getElementById('raceSelector'); // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å–å¾—
    const raceDate = document.getElementById('raceDate').value;
    const venue = document.getElementById('venue').value;
    const raceNum = document.getElementById('raceNum').value;
    const track = document.getElementById('track').value;
    const distance = document.getElementById('distance').value;
    const weight = document.getElementById('weightType').value;
    const count = document.getElementById('horseCount').value;
    const warningEl = document.getElementById('genericWarning');   // æ³¨æ„æ›¸ãè¦ç´ ã‚’å–å¾—

    const foundRace = RACE_LIST.find(race => 
        race.raceDate === raceDate && 
        race.venue === venue && 
        race.raceNum === raceNum &&
        race.track === track &&
        race.distance === distance &&
        parseInt(count) === race.horseCount
    );

    const resetBtn = document.getElementById('resetBtn');

    // --- ãƒ†ã‚­ã‚¹ãƒˆå‡ºã—åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ ---
if (foundRace) {
        isRace = true;
        currentActiveRace = foundRace;
        document.getElementById('mainTitle').innerText = `ğŸ† ${foundRace.title} ğŸ†`;
        
        // ç‰¹å®šãƒ¬ãƒ¼ã‚¹é¸æŠæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        warningEl.innerText = "é¦¬å ´çŠ¶æ…‹ã‚’é¸æŠã—ã¦ã€äºˆæƒ³ã®ç¨®ã‚’è’”ã„ã¦ã­ï¼\nçµæœã«ã¯é¦¬ç•ªãƒ»é¦¬åãƒ»é¨æ‰‹åãªã©ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆï¼";
        resetBtn.style.display = "none";
    } else {
        isRace = false;
        currentActiveRace = null;
        document.getElementById('mainTitle').innerText = "ğŸ‡ æ±ç”¨ãƒ¢ãƒ¼ãƒ‰ ğŸ‡";
        
        // æ±ç”¨ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        warningEl.innerText = "ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã‚’é¸æŠã—ã¦ã€äºˆæƒ³ã®ç¨®ã‚’è’”ã„ã¦ã­ï¼\nâš ï¸ çµæœã¯é¦¬ç•ªã®ã¿ã§ã€é¦¬åã¯å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ğŸ™‡â€â™‚ï¸";
        resetBtn.style.display = "block";
        resetBtn.innerText = "ãƒªã‚»ãƒƒãƒˆ";
    }

    // æ³¨æ„æ›¸ãã®è¡¨ç¤ºè‡ªä½“ã¯å¸¸ã« blockï¼ˆè¡¨ç¤ºï¼‰ã§OK
    warningEl.style.display = "block";
    warningEl.style.borderLeftColor = "var(--theme-color)";

    // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('copyBtn').style.display = "none";
    document.getElementById('xBtn').style.display = "none";
    document.getElementById('saveBtn').style.display = "none"; 
    document.getElementById('result').innerHTML = "";
}

function resetToDefault() {
    const selector = document.getElementById('raceSelector');
    const index = selector.value;
    if (index !== "-1") {
        applySelectedRace(index);
    } else {
        document.getElementById('word1').value = "";
        document.getElementById('word2').value = "";
        document.getElementById('word3').value = "";
        checkRaceMode();
    }
}

function updateTheme() {
    const track = document.getElementById('track').value;
    const root = document.documentElement;
    const banner = document.getElementById('topBanner');
    
    if (track === "ãƒ€ãƒ¼ãƒˆ") {
        root.style.setProperty('--theme-color', '#a67c52');
        root.style.setProperty('--theme-hover', '#8c6543');
    } else {
        root.style.setProperty('--theme-color', '#27ae60');
        root.style.setProperty('--theme-hover', '#219150');
    }
    // ãƒãƒŠãƒ¼ã®è‰²ã‚‚ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹
    banner.style.backgroundColor = getComputedStyle(root).getPropertyValue('--theme-color');
}

function validateInputs() {
    const venue = document.getElementById('venue').value;
    const raceNum = document.getElementById('raceNum').value;
    const ageLimit = document.getElementById('ageLimit').value;
    const raceClass = document.getElementById('raceClass').value;
    const track = document.getElementById('track').value;
    const distance = document.getElementById('distance').value;
    const weightType = document.getElementById('weightType').value;
    const horseCount = document.getElementById('horseCount').value;
    const condition = document.getElementById('condition').value;
    const w1 = document.getElementById('word1').value;
    const w2 = document.getElementById('word2').value;
    const w3 = document.getElementById('word3').value;
    const errorEl = document.getElementById('errorMessage');

    const isRaceConfigOk = venue && raceNum && ageLimit && raceClass && track && distance && weightType && horseCount && condition;
    const isWordOk = w1 || w2 || w3;

    if (isRaceConfigOk && isWordOk) {
        errorEl.classList.remove('show');
        return true;
    }
    return false;
}

function generatePrediction() {
    const errorEl = document.getElementById('errorMessage');
    const showError = (message) => {
        errorEl.innerText = message;
        errorEl.classList.add('show');
        errorEl.scrollIntoView({behavior: 'smooth', block: 'center'});
    };

    const isValid = validateInputs();

    if (!isValid) {
        const w1 = document.getElementById('word1').value;
        const w2 = document.getElementById('word2').value;
        const w3 = document.getElementById('word3').value;
        if (!w1 && !w2 && !w3) { 
            showError("ã‚¨ãƒ©ãƒ¼ï¼šæœ€ä½1ã¤ã€äºˆæƒ³ã®ç¨®ã‚’è’”ã„ã¦ã­ï¼");
        } else {
            showError("ã‚¨ãƒ©ãƒ¼ï¼šæœªé¸æŠã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚");
        }
        return;
    }

    // Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã«ã€Œäºˆæƒ³å®Ÿè¡Œã€ã¨ã„ã†è¨˜éŒ²ã‚’é€ã‚‹
    gtag('event', 'prediction_executed', {
        'event_category': 'engagement',
        'event_label': 'Generate Button'
    });


    const date = document.getElementById('raceDate').value;
    const venue = document.getElementById('venue').value;
    const raceNum = document.getElementById('raceNum').value;
    const w1 = document.getElementById('word1').value;
    const w2 = document.getElementById('word2').value;
    const w3 = document.getElementById('word3').value;
    const horseCount = document.getElementById('horseCount').value;
    const count = parseInt(horseCount);

    let seed = 0;
    const combined = date + venue + raceNum + 
                     document.getElementById('ageLimit').value + 
                     document.getElementById('raceClass').value + 
                     document.getElementById('track').value + 
                     document.getElementById('distance').value + 
                     document.getElementById('weightType').value + 
                     document.getElementById('condition').value + w1 + w2 + w3;

    for (let i = 0; i < combined.length; i++) {
        seed = (seed + combined.charCodeAt(i) * (i + 1)) % 1000000;
    }

    let horses = Array.from({length: count}, (_, i) => i + 1);
    for (let i = horses.length - 1; i > 0; i--) {
        seed = (seed * 9301 + 49297) % 233280;
        const j = Math.floor((seed / 233280) * (i + 1));
        [horses[i], horses[j]] = [horses[j], horses[i]];
    }

    const marks = [{s: "â—"}, {s: "â—¯"}, {s: "â–²"}, {s: "â–³"}, {s: "â­ï¸"}];

    let html = "<h3>çµæœ</h3><div class='prediction-card'>";
    let copyText = `ã€${document.getElementById('mainTitle').innerText}ã€‘\n`;
    copyText += `${date} ${venue}${raceNum}\n\n`;

    let usedWords = [w1, w2, w3].filter(w => w !== "").join("\n");
    if (usedWords) copyText += `è’”ã„ãŸç¨®ï¼š\n${usedWords}\n\n`;

    for(let i = 0; i < 5; i++) {
        if (i >= count) break;
        const horseNum = horses[i];
        const waku = getWakuInfo(horseNum, count);
        let infoHtml = "";
        let lineText = `${marks[i].s} ${horseNum}`;

        if (isRace && currentActiveRace) {
            const horse = currentActiveRace.horses[horseNum - 1] || { name: horseNum + "ç•ª", info: "", jockey: "" };
            infoHtml = `
                <div class="horse-info">
                    <div class="horse-name">${horse.name}ï¼ˆ${horse.info}ï¼‰</div>
                    <div class="jockey-name">${horse.jockey}</div>
                </div>`;
            lineText += ` ${horse.name}`;
        }

        html += `
            <div class="prediction-item">
                <div class="mark">${marks[i].s}</div>
                <div class="waku-box" style="background:${waku.bg}; color:${waku.txt}">${horseNum}</div>
                ${infoHtml}
            </div>`;
        copyText += lineText + "\n";
    }
    
    document.getElementById('result').innerHTML = html + "</div>";
    currentPredictionText = copyText + "\n#äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³";
    document.getElementById('saveBtn').style.display = "block";
    document.getElementById('xBtn').style.display = "block";
    document.getElementById('copyBtn').style.display = "block";
}

async function saveAsImage() {
    const target = document.querySelector("#result .prediction-card");
    if (!target) return;
    try {
        const canvas = await html2canvas(target, {
            scale: 2,
            backgroundColor: "#ffffff",
            logging: false,
            width: target.offsetWidth,
            height: target.offsetHeight,
            scrollX: 0,
            scrollY: -window.scrollY,
            useCORS: true
        });
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const file = new File([blob], `prediction_${new Date().getTime()}.png`, { type: 'image/png' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({ files: [file], title: 'äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³ï¼', text: currentPredictionText });
        } else {
            handleFallbackSave(canvas.toDataURL("image/png"));
        }
    } catch (error) { console.error("Error sharing:", error); }
}

function handleFallbackSave(imageData) {
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
        const modal = document.getElementById('imageModal');
        const previewImg = document.getElementById('previewImage');
        previewImg.src = imageData;
        modal.style.display = 'flex';
    } else {
        const link = document.createElement("a");
        link.download = `prediction_${new Date().getTime()}.png`;
        link.href = imageData;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function postToX() {
    const text = encodeURIComponent(currentPredictionText);
    const url = `https://twitter.com/intent/tweet?text=${text}`;
    window.open(url, '_blank');
}

function copyResult() {
    navigator.clipboard.writeText(currentPredictionText).then(() => {
        alert("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼SNSç­‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
    }).catch(err => { alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); });
}

function getWakuInfo(num, total) {
    const colors = [{bg:"#fff",txt:"#333"},{bg:"#333",txt:"#fff"},{bg:"#e74c3c",txt:"#fff"},{bg:"#3498db",txt:"#fff"},{bg:"#f1c40f",txt:"#333"},{bg:"#27ae60",txt:"#fff"},{bg:"#e67e22",txt:"#fff"},{bg:"#ff9ff3",txt:"#333"}];
    let w = 1;
    if (total <= 8) w = num;
    else {
        const b = Math.floor(total / 8), r = total % 8;
        let cur = 0;
        for(let i=1; i<=8; i++) {
            cur += (b + (i > (8 - r) ? 1 : 0));
            if(num <= cur) { w = i; break; }
        }
    }
    return colors[w-1];
}
</script>
</body>
</html>
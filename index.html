<!DOCTYPE html>
<html lang="ja">
<head>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TEDXL8L716"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-TEDXL8L716');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta property="og:url" content="https://true-ocean.github.io/JRA_Prediction_App/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ğŸ äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³ï¼">
    <meta property="og:description" content="å¥½ããªè¨€è‘‰ã‚’ç¨®ã«ã—ã¦ã€ã‚ãªãŸã ã‘ã®é¦¬ã‚’é¸ã¼ã†ï¼">
    <meta property="og:image" content="https://true-ocean.github.io/JRA_Prediction_App/app_image.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ğŸ äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³ï¼">
    <meta name="twitter:description" content="å¥½ããªè¨€è‘‰ã‚’ç¨®ã«ã—ã¦ã€ã‚ãªãŸã ã‘ã®é¦¬ã‚’é¸ã¼ã†ï¼">
    <meta name="twitter:image" content="https://true-ocean.github.io/JRA_Prediction_App/app_image.png">

    <title>ğŸ äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³ï¼</title>
    <style>
        :root {
            --theme-color: #27ae60;
            --theme-hover: #219150;
            --accent-color: #27ae60;
            --reset-color: #95a5a6;
            --copy-color: #34495e;
        }
        
        /* ãƒãƒŠãƒ¼è¨­å®š */
        .top-banner {
            background: var(--theme-color);
            color: white;
            text-align: center;
            padding: 15px 10px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* bodyã®èƒŒæ™¯ã‚’ç”»åƒã«å¤‰æ›´ */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-image: url('app_image.png');
            background-size: cover;
            /* fixedã§ã¯ãªãã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚å‹•ã‹ãªã„ã‚ˆã†ã«æ“¬ä¼¼çš„ã«å›ºå®š */
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #333;
            padding: 0;
            margin: 0;
            transition: 0.3s;
            min-height: 100vh;
        }

        /* iOSãªã©ã§background-attachment: fixedãŒä¸å®‰å®šãªå ´åˆã®è£œå¼·ç­– */
        @media screen and (max-width: 768px) {
            body::before {
                content: "";
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                z-index: -1;
                width: 100%;
                height: 100vh;
                background: url('app_image.png') center center / cover no-repeat;
            }
            body {
                background-image: none; /* æœ¬ä½“å´ã®èƒŒæ™¯ã‚’æ¶ˆã—ã¦æ“¬ä¼¼è¦ç´ ã«ä»»ã›ã‚‹ */
            }
        }

        /* ä¸­å¤®ã®ç™½ã„ãƒ‘ãƒãƒ«ã‚’åŠé€æ˜ã«ã™ã‚‹ */
        .container {
            background: rgba(255, 255, 255, 0.5); /* æœ€å¾ŒãŒé€æ˜åº¦ã€‚å¾Œã‚ã‚’é€ã‹ã—ã¾ã™ */
            backdrop-filter: blur(8px); /* èƒŒå¾Œã‚’ã¼ã‹ã™ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆiOSãªã©ã§ç¶ºéº—ã«è¦‹ãˆã¾ã™ï¼‰ */
            -webkit-backdrop-filter: blur(8px);
            max-width: 600px;
            margin: 15px auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* ãƒãƒŠãƒ¼ã‚‚å°‘ã—é€éã•ã›ã‚‹ */
        .top-banner {
            background: var(--theme-color);
            opacity: 0.95;
            color: white;
            text-align: center;
            padding: 15px 10px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 { text-align: center; color: #2c3e50; border-bottom: 2px solid var(--theme-color); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; transition: 0.3s; }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; align-items: stretch;}
        label { font-weight: bold; margin-bottom: 5px; font-size: 0.85em; color: #555; text-align: left;}
        select, input { padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; background: #fff; width: 100%; 
            box-sizing: border-box; -webkit-appearance: none; appearance: none; display: block; text-align: left; text-align-last: left; }
        
        /* iOSã®æ—¥ä»˜å…¥åŠ›æ¬„ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚„ä¸­èº«ã‚’å·¦å¯„ã›ã«ã™ã‚‹ãŸã‚ã®å‘ªæ–‡ */
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            right: 10px;
        }
        input[type="date"] {
            position: relative;
        }

        /* ç„¡åŠ¹åŒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        select:disabled, input:disabled {
            background-color: #f0f0f0;
            color: #999;
            cursor: not-allowed;
            border-color: #ddd;
            opacity: 1;
            -webkit-text-fill-color: #999;
        }
        
        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚¹ãƒãƒ›ã§ã‚‚2åˆ—ã‚’ç¶­æŒã™ã‚‹ã‚¯ãƒ©ã‚¹ï¼‰ */
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 5px; }

        /* ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ */
        .label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .btn-hint {
            background: #f39c12;
            color: white;
            padding: 2px 10px;
            font-size: 0.75em;
            border-radius: 4px;
            width: auto;
            cursor: pointer;
        }

        .word-inputs { display: flex; flex-direction: column; gap: 8px; width: 100%; }

        /* ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .button-stack { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        button { width: 100%; padding: 15px; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; box-sizing: border-box; }
        
        .btn-predict { background: var(--theme-color); font-size: 18px; }
        .btn-predict:hover { opacity: 0.9; }
        .btn-reset { background: var(--reset-color); display: none; } /* display: none ã‚’è¿½åŠ  */
        .btn-copy { background: var(--copy-color); display: none; }
        button:active { transform: scale(0.98); }

        /* çµæœè¡¨ç¤º */
        #result { margin-top: 25px; }
        .prediction-card {
            border: 1px solid rgba(0, 0, 0, 0.1); 
            border-radius: 8px; 
            background: rgba(255, 255, 255, 0.5); /* ç™½èƒŒæ™¯ã‚’é€é */
            backdrop-filter: blur(4px); /* çµæœéƒ¨åˆ†ã‚‚ã†ã£ã™ã‚‰ã¼ã‹ã™ */
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .prediction-item { 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            padding: 10px 12px; 
            border-bottom: 1px solid #eee;
            min-width: 320px;
            box-sizing: border-box;
        }

        .prediction-item:last-child { border-bottom: none; }
        .mark { width: 30px; font-weight: bold; font-size: 1.2em; text-align: center; flex-shrink: 0; }
        .waku-box { width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; margin-left: 10px; flex-shrink: 0; }
        .horse-info { margin-left: 12px; display: flex; flex-direction: column; min-width: 0; flex: 1;}
        .horse-name-row { display: flex; align-items: baseline; gap: 8px; }
        .horse-name { font-weight: bold; font-size: 1.05em; color: #2c3e50; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .horse-info-meta { font-size: 0.8em; color: #888; font-weight: normal; } /* æ€§é½¢ã®è‰²ã‚’è–„ãè¨­å®š */
        .jockey-name { font-size: 0.85em; color: #666; margin-top: 1px; }
                
        #errorMessage {
            text-align: center;
            white-space: pre-line;
            font-size: 0.9em;
            opacity: 0;
            max-height: 0;
            margin-bottom: 0;
            padding: 0;
            visibility: hidden;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        #errorMessage.show {
            opacity: 1;
            max-height: 100px;
            margin-bottom: 15px;
            padding: 12px;
            visibility: visible;
            background-color: #e74c3c;
            color: #fff;
            border-radius: 8px;
            border: 1px solid #c0392b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<body>

<div class="top-banner" id="topBanner">
    ğŸ‡ äºˆæƒ³ã®ç¨®ã‚’è’”ã„ã¦ç°¡å˜ãŠé¦¬é¸ã³ï¼ğŸ‡
</div>

<div class="container">

    <h1 id="mainTitle">ğŸ‡ æ±ç”¨ãƒ¢ãƒ¼ãƒ‰ ğŸ‡</h1>
    
    <p id="genericWarning" style="text-align: center; font-size: 0.8em; color: #666; line-height: 1.6; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 6px; border-left: 4px solid var(--theme-color);">
        ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã‚’é¸æŠã—ã¦ã€äºˆæƒ³ã®ç¨®ã‚’è’”ã„ã¦ã­ï¼<br>
        âš ï¸ çµæœã¯é¦¬ç•ªã®ã¿ã§ã€é¦¬åã¯å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“
    </p>

    <div class="form-group">
        <label>ãƒ¬ãƒ¼ã‚¹é¸æŠ</label>
        <select id="raceSelector" onchange="applySelectedRace()">
            <option value="-1">è‡ªåˆ†ã§ãƒ¬ãƒ¼ã‚¹æ¡ä»¶é¸æŠ</option>
        </select>
    </div>

    <div class="row">
        <div class="form-group">
            <label>é–‹å‚¬æ—¥</label>
            <input type="date" id="raceDate" onchange="checkRaceMode()">
        </div>
        <div class="form-group"><label>ã‚¯ãƒ©ã‚¹</label>
            <select id="raceClass" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option selected>G1</option><option>G2</option><option>G3</option><option>OP(L)</option>
                <option>ï½µï½°ï¾Œï¾Ÿï¾</option><option>3å‹ï½¸ï¾—ï½½</option><option>2å‹ï½¸ï¾—ï½½</option>
                <option>1å‹ï½¸ï¾—ï½½</option><option>æœªå‹åˆ©</option><option>æ–°é¦¬</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group">
            <label>ç«¶é¦¬å ´</label>
            <select id="venue" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option>æœ­å¹Œ</option><option>å‡½é¤¨</option><option>æ–°æ½Ÿ</option><option>ç¦å³¶</option>
                <option selected>æ±äº¬</option><option>ä¸­å±±</option><option>ä¸­äº¬</option><option>äº¬éƒ½</option>
                <option>é˜ªç¥</option><option>å°å€‰</option>
            </select>
        </div>
        <div class="form-group"><label>ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
            <select id="raceNum" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <script>for(let i=1;i<=12;i++){ const sel = (i===11?'selected':''); document.write(`<option value="${i}R" ${sel}>${i}R</option>`); }</script>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group"><label>å¹´é½¢é™å®š</label>
            <select id="ageLimit" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option>2æ­³</option><option>2æ­³ ç‰</option><option>3æ­³</option><option>3æ­³ ç‰</option>
                <option>3æ­³ä¸Š</option><option>3æ­³ä¸Š ç‰</option><option selected>4æ­³ä¸Š</option><option selected>4æ­³ä¸Š ç‰</option>
            </select>
        </div>
        <div class="form-group"><label>é‡é‡</label>
            <select id="weightType" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option selected>å®šé‡</option><option>åˆ¥å®š</option><option>é¦¬é½¢</option><option>ãƒãƒ³ãƒ‡</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group"><label>ãƒˆãƒ©ãƒƒã‚¯</label>
            <select id="track" onchange="updateTheme(); checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option value="èŠ">èŠ</option>
                <option value="ãƒ€ãƒ¼ãƒˆ" selected>ãƒ€ãƒ¼ãƒˆ</option>
            </select>
        </div>
        <div class="form-group"><label>è·é›¢</label>
            <select id="distance" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <script>
                    const dists = ['1000','1150','1200','1300','1400','1500','1600','1700','1800','1900','2000','2100','2200','2300','2400','2500','2600','3000','3200','3400','3600'];
                    dists.forEach(d => {
                        const sel = (d === '1600' ? 'selected' : '');
                        document.write(`<option value="${d}" ${sel}>${d}m</option>`);
                    });
                </script>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group">
            <label>å‡ºèµ°é ­æ•°</label>
            <select id="horseCount" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <script>
                    for(let i=5; i<=18; i++) {
                        const selected = i === 16 ? 'selected' : '';
                        document.write(`<option value="${i}" ${selected}>${i}é ­</option>`);
                    }
                </script>
            </select>
        </div>
        <div class="form-group"><label>é¦¬å ´çŠ¶æ…‹</label>
            <select id="condition" onchange="validateInputs()">
                <option value="" selected>-- é¸æŠ --</option>
                <option>è‰¯</option><option>ç¨é‡</option><option>é‡</option><option>ä¸è‰¯</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <label style="margin-bottom: 0;">äºˆæƒ³ã®ç¨®</label>
            <div style="display: flex; gap: 5px; margin-right: 10px;">
                <button type="button" onclick="showHints()" style="width: 120px; padding: 4px 10px; font-size: 0.7em; background: #f39c12; margin: 0; line-height: 1; border-radius: 4px;">ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º</button>
                <button type="button" onclick="resetHints()" style="width: 120px; padding: 4px 10px; font-size: 0.7em; background: #95a5a6; margin: 0; line-height: 1; border-radius: 4px;">ãƒ’ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
        <div class="word-inputs">
            <input type="text" id="word1" placeholder="ç¨® 1ï¼ˆã©ã‚“ãªè¨€è‘‰ã§ã‚‚OKï¼ï¼‰" oninput="validateInputs(); checkRaceMode()">
            <input type="text" id="word2" placeholder="ç¨® 2ï¼ˆã©ã‚“ãªè¨€è‘‰ã§ã‚‚OKï¼ï¼‰" oninput="validateInputs(); checkRaceMode()">
            <input type="text" id="word3" placeholder="ç¨® 3ï¼ˆã©ã‚“ãªè¨€è‘‰ã§ã‚‚OKï¼ï¼‰" oninput="validateInputs(); checkRaceMode()">
        </div>
    </div>

    <div id="errorMessage"></div>

    <div class="button-stack">
        <button class="btn-predict" onclick="generatePrediction()">äºˆæƒ³ã®ç¨®ã‚’è’”ãï¼</button>
        <button class="btn-reset" id="resetBtn" onclick="resetToDefault()">ç¨®ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="result"></div>

    <div class="button-stack">
        <button class="btn-save" id="saveBtn" onclick="saveAsImage()" style="background: #FF77FF; display: none;">çµæœã‚’ç”»åƒã§ä¿å­˜ãƒ»å…±æœ‰</button>
        <button class="btn-x" id="xBtn" onclick="postToX()" style="background: #000; display: none;">çµæœã‚’ X ã«ãƒã‚¹ãƒˆï¼ˆç”»åƒãªã—ï¼‰</button>
        <button class="btn-copy" id="copyBtn" onclick="copyResult()">çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
    </div>

    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 0.7em; line-height: 1.5;">
        <p style="margin-bottom: 10px;">
            Disclaimer: This application is for entertainment purposes only. It does not provide financial or betting advice. Users are responsible for their own decisions.<br>
            å…è²¬äº‹é …ï¼šæœ¬ã‚¢ãƒ—ãƒªã¯ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€é‡‘èã¾ãŸã¯å‹é¦¬æŠ•ç¥¨ï¼ˆè³­åšï¼‰ã«é–¢ã™ã‚‹åŠ©è¨€ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åˆ©ç”¨è€…ã¯è‡ªå·±ã®è²¬ä»»ã«ãŠã„ã¦æœ¬ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
        </p>
        <p style="text-align: center; font-weight: bold;">
            Created by <a href="#" style="color: #666; text-decoration: none;">ã‚·ãƒ£ãƒãƒ¯ãƒ¼ãƒ«</a>. All rights reserved.
        </p>
    </footer>

</div>

<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center; flex-direction:column; padding: 20px;">
    <p style="color:white; margin-bottom:15px; font-weight:bold; text-align:center;">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦<br>ã€Œ"å†™çœŸ"ã«ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <img id="previewImage" style="max-width:100%; max-height:70%; border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
    <button onclick="document.getElementById('imageModal').style.display='none'" style="margin-top:25px; background:#fff; color:#333; width:auto; padding:12px 40px; border-radius:30px;">é–‰ã˜ã‚‹</button>
</div>

<script>

let RACE_LIST = [];
let isRace = false;
let currentActiveRace = null;
let currentPredictionText = "";

window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('raceDate').value = today;

    // å¤–éƒ¨JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    loadRaceData();
};

async function loadRaceData() {
    try {
        // race_list.json ã‚’èª­ã¿è¾¼ã¿
        const response = await fetch('race_list.json');
        if (!response.ok) throw new Error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        RACE_LIST = await response.json();

        // èª­ã¿è¾¼ã¿çµ‚ã‚ã£ãŸå¾Œã«ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ§‹ç¯‰
        const selector = document.getElementById('raceSelector');
        selector.innerHTML = '<option value="-1">è‡ªåˆ†ã§ãƒ¬ãƒ¼ã‚¹æ¡ä»¶é¸æŠ</option>'; // åˆæœŸåŒ–
        
        RACE_LIST.forEach((race, index) => {
            const opt = document.createElement('option');
            opt.value = index;
            opt.innerText = race.raceClass + " " + race.title;
            selector.appendChild(opt);
        });

        selector.value = "-1";
        applySelectedRace("-1");
        
    } catch (error) {
        console.error('Error:', error);
    }
}

function toggleInputsDisabled(isDisabled) {
    const targetIds = [
        'raceDate', 'venue', 'raceNum', 'ageLimit', 
        'raceClass', 'track', 'distance', 'weightType', 'horseCount'
    ];
    targetIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = isDisabled;
    });
}

function applySelectedRace(forcedIndex = null) {
    const selector = document.getElementById('raceSelector');
    const index = forcedIndex !== null ? forcedIndex : selector.value;
    const errorEl = document.getElementById('errorMessage');
    if (errorEl) errorEl.classList.remove('show');

    if (index === "-1") {
        toggleInputsDisabled(false);
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('raceDate').value = today;
        document.getElementById('venue').value = "";
        document.getElementById('raceNum').value = "";
        document.getElementById('ageLimit').value = "";
        document.getElementById('raceClass').value = "";
        document.getElementById('track').value = "";
        document.getElementById('distance').value = "";
        document.getElementById('weightType').value = "";
        document.getElementById('condition').value = "";
        document.getElementById('horseCount').value = "";
        document.getElementById('word1').value = "";
        document.getElementById('word2').value = "";
        document.getElementById('word3').value = "";
        updateTheme();
        checkRaceMode();
        return;
    }
    
    toggleInputsDisabled(true);
    const race = RACE_LIST[index];
    document.getElementById('raceDate').value = race.raceDate;
    document.getElementById('venue').value = race.venue;
    document.getElementById('raceNum').value = race.raceNum;
    document.getElementById('ageLimit').value = race.ageLimit;
    document.getElementById('raceClass').value = race.raceClass;
    document.getElementById('track').value = race.track;
    document.getElementById('distance').value = race.distance;
    document.getElementById('weightType').value = race.weightType;
    document.getElementById('condition').value = "";
    document.getElementById('horseCount').value = race.horseCount;
    document.getElementById('word1').value = "";
    document.getElementById('word2').value = "";
    document.getElementById('word3').value = "";
    updateTheme();
    checkRaceMode();
}

function checkRaceMode() {
    const raceSelector = document.getElementById('raceSelector'); // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å–å¾—
    const raceDate = document.getElementById('raceDate').value;
    const venue = document.getElementById('venue').value;
    const raceNum = document.getElementById('raceNum').value;
    const track = document.getElementById('track').value;
    const distance = document.getElementById('distance').value;
    const weight = document.getElementById('weightType').value;
    const count = document.getElementById('horseCount').value;
    const warningEl = document.getElementById('genericWarning');   // æ³¨æ„æ›¸ãè¦ç´ ã‚’å–å¾—

    const foundRace = RACE_LIST.find(race => 
        race.raceDate === raceDate && 
        race.venue === venue && 
        race.raceNum === raceNum &&
        race.track === track &&
        race.distance === distance &&
        parseInt(count) === race.horseCount
    );

    const resetBtn = document.getElementById('resetBtn');

    // å…¥åŠ›çŠ¶æ³ã‚’å–å¾—ï¼ˆvalidateInputsã®çµæœã‚’åˆ©ç”¨ï¼‰
    const status = validateInputs();
    
    // ãƒ¢ãƒ¼ãƒ‰(isRace)ã«é–¢ä¿‚ãªãã€ç¨®ãŒ1ã¤ã§ã‚‚å…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°è¡¨ç¤º
    if (status.wordOk) {
        resetBtn.style.display = "block";
    } else {
        resetBtn.style.display = "none";
    }

    // --- ãƒ†ã‚­ã‚¹ãƒˆå‡ºã—åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ ---
    if (foundRace) {
        isRace = true;
        currentActiveRace = foundRace;
        document.getElementById('mainTitle').innerText = `ğŸ† ${foundRace.title} ğŸ†`;
        
        // ç‰¹å®šãƒ¬ãƒ¼ã‚¹é¸æŠæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        warningEl.innerText = "é¦¬å ´çŠ¶æ…‹ã‚’é¸æŠã—ã¦ã€äºˆæƒ³ã®ç¨®ã‚’è’”ã„ã¦ã­ï¼\nçµæœã«ã¯é¦¬ç•ªãƒ»é¦¬åãƒ»é¨æ‰‹åãªã©ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆï¼";

    } else {
        isRace = false;
        currentActiveRace = null;
        
        const vVal = document.getElementById('venue').value;
        const nVal = document.getElementById('raceNum').value;
        const aVal = document.getElementById('ageLimit').value;
        const cVal = document.getElementById('raceClass').value;

        // é …ç›®ãŒæœªé¸æŠã®å ´åˆã¯ã€Œæ±ç”¨ãƒ¢ãƒ¼ãƒ‰ã€ã¨ã—ã€æƒã£ã¦ã„ãŸã‚‰ã€Œç«¶é¦¬å ´ãƒ»Rãƒ»æ¡ä»¶ã€ã‚’è¡¨ç¤º
        if (vVal && nVal && aVal && cVal) {
            document.getElementById('mainTitle').innerText = `ğŸ‡ ${vVal} ${nVal} ${aVal} ${cVal} ğŸ‡`;
        } else {
            document.getElementById('mainTitle').innerText = "ğŸ‡ æ±ç”¨ãƒ¢ãƒ¼ãƒ‰ ğŸ‡";
        }
        warningEl.innerText = "ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã‚’é¸æŠã—ã¦ã€äºˆæƒ³ã®ç¨®ã‚’è’”ã„ã¦ã­ï¼\nâš ï¸ çµæœã¯é¦¬ç•ªã®ã¿ã§ã€é¦¬åã¯å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ğŸ™‡â€â™‚ï¸";

    }

    // æ³¨æ„æ›¸ãã®è¡¨ç¤ºè‡ªä½“ã¯å¸¸ã« blockï¼ˆè¡¨ç¤ºï¼‰ã§OK
    warningEl.style.display = "block";
    warningEl.style.borderLeftColor = "var(--theme-color)";

    // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('copyBtn').style.display = "none";
    document.getElementById('xBtn').style.display = "none";
    document.getElementById('saveBtn').style.display = "none"; 
    document.getElementById('result').innerHTML = "";
}

function resetToDefault() {
    document.getElementById('word1').value = "";
    document.getElementById('word2').value = "";
    document.getElementById('word3').value = "";
    checkRaceMode();
}

function updateTheme() {
    const track = document.getElementById('track').value;
    const root = document.documentElement;
    const banner = document.getElementById('topBanner');
    
    if (track === "ãƒ€ãƒ¼ãƒˆ") {
        root.style.setProperty('--theme-color', '#a67c52');
        root.style.setProperty('--theme-hover', '#8c6543');
    } else {
        root.style.setProperty('--theme-color', '#27ae60');
        root.style.setProperty('--theme-hover', '#219150');
    }
    // ãƒãƒŠãƒ¼ã®è‰²ã‚‚ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹
    banner.style.backgroundColor = getComputedStyle(root).getPropertyValue('--theme-color');
}

function validateInputs() {
    // 1. å„é …ç›®ã®å€¤ã‚’å–å¾—
    const venue = document.getElementById('venue').value;
    const raceNum = document.getElementById('raceNum').value;
    const ageLimit = document.getElementById('ageLimit').value;
    const raceClass = document.getElementById('raceClass').value;
    const track = document.getElementById('track').value;
    const distance = document.getElementById('distance').value;
    const weightType = document.getElementById('weightType').value;
    const horseCount = document.getElementById('horseCount').value;
    const condition = document.getElementById('condition').value;
    
    // trim()ã‚’å…¥ã‚Œã¦ç©ºç™½ã®ã¿ã®å…¥åŠ›ã‚’é˜²ã
    const w1 = document.getElementById('word1').value.trim();
    const w2 = document.getElementById('word2').value.trim();
    const w3 = document.getElementById('word3').value.trim();
    
    const errorEl = document.getElementById('errorMessage');

    // 2. çŠ¶æ…‹ã®åˆ¤å®š
    const isRaceConfigOk = venue && raceNum && ageLimit && raceClass && track && distance && weightType && horseCount && condition;
    const isWordOk = w1 || w2 || w3;

    // 3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®ã‚¨ãƒ©ãƒ¼æ¶ˆå»ãƒ­ã‚¸ãƒƒã‚¯
    // ã€Œæœªé¸æŠã‚¨ãƒ©ãƒ¼ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ™‚ã«ã€å…¨é …ç›®ãŒåŸ‹ã¾ã£ãŸã‚‰æ¶ˆã™
    if (isRaceConfigOk && errorEl.innerText === "ã‚¨ãƒ©ãƒ¼ï¼šæœªé¸æŠã®é …ç›®ãŒã‚ã‚‹ã‚ˆï¼") {
        errorEl.classList.remove('show');
    }
    // ã€Œç¨®ã®æ¬ å¦‚ã‚¨ãƒ©ãƒ¼ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ™‚ã«ã€ç¨®ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰æ¶ˆã™
    if (isWordOk && errorEl.innerText === "ã‚¨ãƒ©ãƒ¼ï¼šæœ€ä½1ã¤ã¯ç¨®ã‚’è’”ã„ã¦ã­ï¼") {
        errorEl.classList.remove('show');
    }

    // 4. æœ€çµ‚çš„ãªæœ‰åŠ¹æ€§ã‚’è¿”ã™ï¼ˆä¸¡æ–¹OKãªã‚‰trueï¼‰
    return {
        allOk: isRaceConfigOk && isWordOk,
        raceOk: isRaceConfigOk,
        wordOk: isWordOk
    };
}

function showHints() {
    const questions = [
        "ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ", "å¥½ããªè‰²ã¯ï¼Ÿ", "å«Œã„ãªé£Ÿã¹ç‰©ã¯ï¼Ÿ", "æœ€è¿‘é£Ÿã¹ãŸãŠã‚„ã¤ã¯ï¼Ÿ",
        "ä»Šã®å¤©æ°—ã¯ï¼Ÿ", "æ˜¨æ—¥è¦‹ãŸå¤¢ã¯ï¼Ÿ", "å¥½ããªå­£ç¯€ã¯ï¼Ÿ", "ä»Šã®æœã®è‰²ã¯ï¼Ÿ",
        "å¥½ããªæ•°å­—ã¯ï¼Ÿ", "è¡Œã£ã¦ã¿ãŸã„å ´æ‰€ã¯ï¼Ÿ", "å¥½ããªå‹•ç‰©ã¯ï¼Ÿ", "æœ€è¿‘ã®æ°—ã«ãªã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ï¼Ÿ",
        "ç›®ã®å‰ã«ã‚ã‚‹ã‚‚ã®ã¯ï¼Ÿ", "å¥½ããªé¦¬ã®æ¯›è‰²ã¯ï¼Ÿ", "å¥½ããªé£²ã¿ç‰©ã¯ï¼Ÿ", "å®¶æ—æ§‹æˆã¯ï¼Ÿ",
        "ä»Šã®ä½“èª¿ã¯ï¼Ÿ", "å¥½ããªãŠç¬‘ã„ã‚¿ãƒ¬ãƒ³ãƒˆã¯ï¼Ÿ", "å¥½ããªèŠ±ã¯ï¼Ÿ", "ã‚ãªãŸã®è¡€æ¶²å‹ã¨æ˜Ÿåº§ã¯ï¼Ÿ",
        "æ˜¨å¤œã®å¤•é£Ÿã¯ï¼Ÿ", "ä»Šæœã®ç›®è¦šã‚ã¯ï¼Ÿ", "æ€ã„ã¤ã„ãŸå››å­—ç†Ÿèªã¯ï¼Ÿ", "ä»Šæ—¥ã®ç©ºã®è‰²ã¯ï¼Ÿ",
        "ä»Šæ—¥ã®é´ä¸‹ã®è‰²ã¯ï¼Ÿ", "æœ€è¿‘è²·ã£ãŸã‚‚ã®ã¯ï¼Ÿ", "å¥½ããªéŸ³æ¥½ã¯ï¼Ÿ", "ã‚«ãƒãƒ³ã®ä¸­èº«ã¯ï¼Ÿ",
        "æœ€è¿‘ã®æ‚©ã¿ã¯ï¼Ÿ", "é¡˜ã„ãŒå¶ã†ã¨ã—ãŸã‚‰ä½•ã‚’é¡˜ã†ï¼Ÿ", "å¥½ããªã‚¢ãƒ‹ãƒ¡ã‚­ãƒ£ãƒ©ã¯ï¼Ÿ", "ä»Šæ—¥ä¼šã£ãŸäººã¯ï¼Ÿ",
        "è¦–ç•Œã®ç«¯ã«ã‚ã‚‹ã‚‚ã®ã¯ï¼Ÿ", "æœ€è¿‘é©šã„ãŸã“ã¨ã¯ï¼Ÿ", "è‹¦æ‰‹ãªå‹•ç‰©ã¯ï¼Ÿ", "ä»Šèã“ãˆã¦ã„ã‚‹éŸ³ã¯ï¼Ÿ",
        "ä»Šæ—¥ã®èª¿å­ã¯ï¼Ÿ", "æœ€è¿‘ã®å°ã•ãªå¹¸ã›ã¯ï¼Ÿ", "å¥½ããªè¨€è‘‰ã¯ï¼Ÿ", "ä»Šã®å‘¨ã‚Šã®æ˜ã‚‹ã•ã¯ï¼Ÿ",
        "ä»Šæ—¥ã®äºˆå®šã¯ï¼Ÿ", "æœ€è¿‘èª­ã‚“ã æœ¬ã¯ï¼Ÿ", "å¥½ããªæ˜ ç”»ã®ã‚¿ã‚¤ãƒˆãƒ«ã¯ï¼Ÿ", "è¡Œã£ãŸã“ã¨ã®ã‚ã‚‹æ—…è¡Œå…ˆã¯ï¼Ÿ",
        "æœ€è¿‘æ„Ÿå‹•ã—ãŸã“ã¨ã¯ï¼Ÿ", "å¥½ããªã‚¹ãƒãƒ›ã‚²ãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«ã¯ï¼Ÿ", "ä»Šã®ã‚¹ãƒãƒ›ã®é›»æ± æ®‹é‡ã¯ï¼Ÿ", "ä»Šæ—¥æœ€åˆã«è©±ã—ãŸäººã¯ï¼Ÿ",
        "æœ€è¿‘ã®ãƒã‚¤ãƒ–ãƒ¼ãƒ ã¯ï¼Ÿ", "æ¬¡ã®é€±æœ«ã®äºˆå®šã¯ï¼Ÿ", "ä»Šã©ã“ã«ã„ã‚‹ï¼Ÿ", "ä»Šæ—¥ã®ä¸‹ç€ã®æŸ„ã¯ï¼Ÿ",
        "æœ€è¿‘æ°—ã«ãªã£ã¦ã„ã‚‹ãŠåº—ã¯ï¼Ÿ", "å¥½ããªã‚¹ãƒãƒ¼ãƒ„ã¯ï¼Ÿ", "ä»Šä½•æ™‚ï¼Ÿ", "ä»Šæ—¥é ‘å¼µã£ãŸã“ã¨ã¯ï¼Ÿ",
        "å®ãã˜ãŒå½“ãŸã£ãŸã‚‰ï¼Ÿ", "å¥½ããªæœç‰©ã¯ï¼Ÿ", "ä»Šå‘ã„ã¦ã„ã‚‹æ–¹è§’ã¯ï¼Ÿ", "ã‚ˆãè¦‹ã‚‹ãƒ†ãƒ¬ãƒ“ç•ªçµ„ã¯ï¼Ÿ",
        "å¥½ããªé¦¬åˆ¸ã®ç¨®é¡ã¯ï¼Ÿ", "å¥½ããªéŸ³æ¥½ã®ã‚¸ãƒ£ãƒ³ãƒ«ã¯ï¼Ÿ", "ä»Šæ—¥æ°—ã«ãªã£ãŸåºƒå‘Šã¯ï¼Ÿ", "ã‚ˆãä½¿ã†ã‚¢ãƒ—ãƒªã¯ï¼Ÿ",
        "ã‚ãªãŸã®ç‰¹æŠ€ã¯ï¼Ÿ", "å¥½ããªç•°æ€§ã®ã‚¿ã‚¤ãƒ—ã¯ï¼Ÿ", "ã‚ˆãä½¿ã†é›»è»Šã®è·¯ç·šã¯ï¼Ÿ", "æœ€è¿‘ä¼šã„ãŸã„äººã¯ï¼Ÿ",
        "å¥½ããªãƒ†ãƒ¬ãƒ“ç•ªçµ„ã¯ï¼Ÿ", "æ„›ç”¨ã—ã¦ã„ã‚‹ã‚³ãƒƒãƒ—ã®æŸ„ã¯ï¼Ÿ", "ä»Šæ—¥ã¯ä½•æ›œæ—¥ï¼Ÿ", "å¾—æ„æ–™ç†ã¯ï¼Ÿ",
        "å¥½ããªãƒ‡ã‚¶ãƒ¼ãƒˆã¯ï¼Ÿ", "å¥½ããªæ˜ ç”»ä¿³å„ªã¯ï¼Ÿ", "ä»Šæ—¥ã®ç›®æ¨™ã¯ï¼Ÿ", "å¥½ããªã‚¢ã‚¤ãƒ‰ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã¯ï¼Ÿ",
        "å¥½ããªãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¯ï¼Ÿ", "ãƒšãƒƒãƒˆã®åå‰ã¯ï¼Ÿ", "æ€ã„æµ®ã‹ã‚“ã å‹é”ã®åå‰ã¯ï¼Ÿ", "å¥½ããªæœã®ãƒ–ãƒ©ãƒ³ãƒ‰ã¯ï¼Ÿ",
        "æœ€å¯„ã‚Šé§…ã®åå‰ã¯ï¼Ÿ", "æŒ¯ã‚Šå‘ã„ãŸå…ˆã«ã‚ã‚‹ã‚‚ã®ã¯ï¼Ÿ", "ä»Šæ—¥ã®ãŠè²¡å¸ƒã®ä¸­èº«ã¯ï¼Ÿ", "è¡Œã£ã¦ã¿ãŸã„å›½ã¯ï¼Ÿ",
        "å¥½ããªä¹—ã‚Šç‰©ã¯ï¼Ÿ", "ãƒãƒ¼ã‚«ãƒ¼ã®å½¹ã§æ€ã„æµ®ã‹ã¶ã®ã¯ï¼Ÿ", "å¥½ããªã‚¹ã‚¤ãƒ¼ãƒ„ã¯ï¼Ÿ", "å¥½ããªæ¼«ç”»ã¯ï¼Ÿ", 
        "å¥½ããªè»Šã®ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼è»Šç¨®ã¯ï¼Ÿ", "æœ€è¿‘ãƒãƒã£ã¦ã„ã‚‹ã“ã¨ã¯ï¼Ÿ", "ã‚¹ãƒãƒ›ã®å£ç´™ã¯ï¼Ÿ", "ã‚¹ãƒãƒ›ã®ãƒ›ãƒ¼ãƒ ç”»é¢å·¦ä¸Šã®ã‚¢ãƒ—ãƒªã¯ï¼Ÿ",
        "è¦ªæˆšãŒä½ã‚“ã§ã„ã‚‹å ´æ‰€ã¯ï¼Ÿ", "ä»Šæ€ã„æµ®ã‹ã‚“ã æ­´å²ä¸Šã®äººç‰©ã¯ï¼Ÿ", "ã“ã‚Œã¾ã§ã«ã‚„ã£ãŸã“ã¨ã®ã‚ã‚‹ç¿’ã„äº‹ã¯ï¼Ÿ",
        "æœ€è¿‘ã®ç¡çœ æ™‚é–“ã¯ï¼Ÿ", "ã‚ãªãŸã®ã“ã ã‚ã‚Šã‚¢ã‚¤ãƒ†ãƒ ã¯ï¼Ÿ", "æœ€è¿‘æ°—ã«ãªã£ãŸãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ï¼Ÿ", "ã‚ˆãè¡Œãé£²é£Ÿåº—ã¯ï¼Ÿ"
    ];

    // é‡è¤‡ãªã3ã¤é¸ã¶
    let shuffled = [...questions].sort(() => 0.5 - Math.random());
    
    // å…¥åŠ›æ¬„ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã«ã‚»ãƒƒãƒˆ
    document.getElementById('word1').placeholder = shuffled[0];
    document.getElementById('word2').placeholder = shuffled[1];
    document.getElementById('word3').placeholder = shuffled[2];

    // ã‚¯ãƒªãƒƒã‚¯ã—ãŸç¬é–“ã«ãµã‚ã£ã¨è‰²ã‚’å¤‰ãˆã‚‹æ¼”å‡ºï¼ˆä»»æ„ï¼‰
    [1, 2, 3].forEach(i => {
        const el = document.getElementById('word' + i);
        el.style.backgroundColor = "#fffde7";
        setTimeout(() => { el.style.backgroundColor = "#fff"; }, 400);
    });
}

function resetHints() {
    document.getElementById('word1').placeholder = "ç¨® 1ï¼ˆã©ã‚“ãªè¨€è‘‰ã§ã‚‚OKï¼ï¼‰";
    document.getElementById('word2').placeholder = "ç¨® 2ï¼ˆã©ã‚“ãªè¨€è‘‰ã§ã‚‚OKï¼ï¼‰";
    document.getElementById('word3').placeholder = "ç¨® 3ï¼ˆã©ã‚“ãªè¨€è‘‰ã§ã‚‚OKï¼ï¼‰";
}

function generatePrediction() {
    const errorEl = document.getElementById('errorMessage');
    const showError = (message) => {
        errorEl.innerText = message;
        errorEl.classList.add('show');
        errorEl.scrollIntoView({behavior: 'smooth', block: 'center'});
    };

    // validateInputs ã‚’å‘¼ã³å‡ºã—ã€è©³ç´°ãªåˆ¤å®šçµæœã‚’å—ã‘å–ã‚‹
    const status = validateInputs();

    // --- å„ªå…ˆé †ä½ã«åŸºã¥ã„ãŸã‚¨ãƒ©ãƒ¼åˆ¤å®š ---

    // ã€æœ€å„ªå…ˆã€‘ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã«æœªé¸æŠãŒã‚ã‚‹å ´åˆ
    if (!status.raceOk) {
        showError("ã‚¨ãƒ©ãƒ¼ï¼šæœªé¸æŠã®é …ç›®ãŒã‚ã‚‹ã‚ˆï¼");
        return;
    }

    // ã€æ¬¡ã«å„ªå…ˆã€‘ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã¯OKã ãŒã€ç¨®ãŒ1ã¤ã‚‚ãªã„å ´åˆ
    if (!status.wordOk) {
        showError("ã‚¨ãƒ©ãƒ¼ï¼šæœ€ä½1ã¤ã¯ç¨®ã‚’è’”ã„ã¦ã­ï¼");
        return;
    }

    // ä¸¡æ–¹OKãªã‚‰ã‚¨ãƒ©ãƒ¼ã‚’æ¶ˆã—ã¦äºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ã¸
    errorEl.classList.remove('show');

    // Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã«ã€Œäºˆæƒ³å®Ÿè¡Œã€ã¨ã„ã†è¨˜éŒ²ã‚’é€ã‚‹
    gtag('event', 'prediction_executed', {
        'event_category': 'engagement',
        'event_label': 'Generate Button'
    });


    const date = document.getElementById('raceDate').value;
    const venue = document.getElementById('venue').value;
    const raceNum = document.getElementById('raceNum').value;
    const w1 = document.getElementById('word1').value;
    const w2 = document.getElementById('word2').value;
    const w3 = document.getElementById('word3').value;
    const horseCount = document.getElementById('horseCount').value;
    const count = parseInt(horseCount);

    let seed = 0;

    const titleText = document.getElementById('mainTitle').innerText;
    const combined = titleText + date + venue + raceNum + 
                     document.getElementById('ageLimit').value + 
                     document.getElementById('raceClass').value + 
                     document.getElementById('track').value + 
                     document.getElementById('distance').value + 
                     document.getElementById('weightType').value + 
                     document.getElementById('condition').value + w1 + w2 + w3;

    for (let i = 0; i < combined.length; i++) {
        seed = (seed + combined.charCodeAt(i) * (i + 1)) % 1000000;
    }

    let horses = Array.from({length: count}, (_, i) => i + 1);
    for (let i = horses.length - 1; i > 0; i--) {
        seed = (seed * 9301 + 49297) % 233280;
        const j = Math.floor((seed / 233280) * (i + 1));
        [horses[i], horses[j]] = [horses[j], horses[i]];
    }

    const marks = [{s: "â—"}, {s: "â—¯"}, {s: "â–²"}, {s: "â–³"}, {s: "â­ï¸"}];

    let html = "<h3>çµæœ</h3><div class='prediction-card'>";
    let copyText = `ã€${document.getElementById('mainTitle').innerText}ã€‘\n`;
    copyText += `${date} ${venue}${raceNum}\n\n`;

    let usedWords = [w1, w2, w3].filter(w => w !== "").join("\n");
    if (usedWords) copyText += `è’”ã„ãŸç¨®ï¼š\n${usedWords}\n\n`;

    for(let i = 0; i < 5; i++) {
        if (i >= count) break;
        const horseNum = horses[i];
        const waku = getWakuInfo(horseNum, count);
        let infoHtml = "";
        let lineText = `${marks[i].s} ${horseNum}`;

        if (isRace && currentActiveRace) {
            const horse = currentActiveRace.horses[horseNum - 1] || { name: horseNum + "ç•ª", info: "", jockey: "" };
            infoHtml = `
                <div class="horse-info">
                    <div class="horse-name-row">
                        <span class="horse-name">${horse.name}</span>
                        <span class="horse-info-meta">${horse.info}</span>
                    </div>
                    <div class="jockey-name">${horse.jockey}</div>
                </div>`;
            lineText += ` ${horse.name}`;
        }

        // æ è‰²
        html += `
            <div class="prediction-item">
                <div class="mark">${marks[i].s}</div>
                <div class="waku-box" style="background-color:${waku.bg}; color:${waku.txt}; border-color:${waku.border};">
                    ${horseNum}
                </div>
                ${infoHtml}
            </div>`;
        copyText += lineText + "\n";
    }
    
    document.getElementById('result').innerHTML = html + "</div>";
    currentPredictionText = copyText + "\n#äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³";

    document.getElementById('resetBtn').style.display = "block";
    document.getElementById('saveBtn').style.display = "block";
    document.getElementById('xBtn').style.display = "block";
    document.getElementById('copyBtn').style.display = "block";
}

async function saveAsImage() {
    const target = document.querySelector("#result .prediction-card");
    if (!target) return;
    try {
        const canvas = await html2canvas(target, {
            scale: 2,
            backgroundColor: "#ffffff",
            logging: false,
            width: target.offsetWidth,
            height: target.offsetHeight,
            scrollX: 0,
            scrollY: -window.scrollY,
            useCORS: true
        });
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const file = new File([blob], `prediction_${new Date().getTime()}.png`, { type: 'image/png' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({ files: [file], title: 'äºˆæƒ³ã®ç¨®ã§ç°¡å˜ãŠé¦¬é¸ã³ï¼', text: currentPredictionText });
        } else {
            handleFallbackSave(canvas.toDataURL("image/png"));
        }
    } catch (error) { console.error("Error sharing:", error); }
}

function handleFallbackSave(imageData) {
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
        const modal = document.getElementById('imageModal');
        const previewImg = document.getElementById('previewImage');
        previewImg.src = imageData;
        modal.style.display = 'flex';
    } else {
        const link = document.createElement("a");
        link.download = `prediction_${new Date().getTime()}.png`;
        link.href = imageData;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function postToX() {
    const text = encodeURIComponent(currentPredictionText);
    const url = `https://twitter.com/intent/tweet?text=${text}`;
    window.open(url, '_blank');
}

function copyResult() {
    navigator.clipboard.writeText(currentPredictionText).then(() => {
        alert("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼SNSç­‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
    }).catch(err => { alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); });
}

function getWakuInfo(num, total) {
    // JRAå…¬å¼ã‚«ãƒ©ãƒ¼ã«æº–æ‹ ã—ãŸè¨­å®š
const wakuStyles = [
        { bg: "#ffffff", txt: "#333", border: "#333" },    // 1æ :ç™½ (å¢ƒç•Œç·šã¯ãƒãƒƒã‚­ãƒª)
        { bg: "#000000", txt: "#fff", border: "#000" },    // 2æ :é»’
        { bg: "#e60012", txt: "#fff", border: "#e60012" }, // 3æ :èµ¤ (é®®ã‚„ã‹ãªèµ¤)
        { bg: "#0000ff", txt: "#fff", border: "#0000ff" }, // 4æ :é’ (ç´”ç²‹ãªé’)
        { bg: "#fff100", txt: "#333", border: "#fff100" }, // 5æ :é»„ (æ˜ã‚‹ã„é»„è‰²)
        { bg: "#007d7a", txt: "#fff", border: "#007d7a" }, // 6æ :ç·‘ (ç”»åƒç‰¹æœ‰ã®æ·±ç·‘)
        { bg: "#ff6600", txt: "#fff", border: "#ff6600" }, // 7æ :æ©™ (ãƒ“ãƒ“ãƒƒãƒˆãªã‚ªãƒ¬ãƒ³ã‚¸)
        { bg: "#ff00ff", txt: "#fff", border: "#ff00ff" }  // 8æ :æ¡ƒ (é®®ã‚„ã‹ãªãƒ”ãƒ³ã‚¯)
    ];

    let w = 1;
    if (total <= 8) {
        w = num;
    } else {
        const b = Math.floor(total / 8), r = total % 8;
        let cur = 0;
        for (let i = 1; i <= 8; i++) {
            cur += (b + (i > (8 - r) ? 1 : 0));
            if (num <= cur) {
                w = i;
                break;
            }
        }
    }
    
    // è¨ˆç®—ã•ã‚ŒãŸæ ç•ª(w)ã«å¯¾å¿œã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿”ã™
    return wakuStyles[w - 1];
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta property="og:url" content="https://true-ocean.github.io/JRA_Prediction_App/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ğŸ ãƒ©ãƒ³ãƒ€ãƒ ãƒ¯ãƒ¼ãƒ‰ã§ç°¡å˜ç«¶é¦¬äºˆæƒ³">
    <meta property="og:description" content="å¥½ããªè¨€è‘‰ã‚’ç¨®ã«ã—ã¦ã€è‡ªåˆ†ã ã‘ã®ç°¡å˜ç«¶é¦¬äºˆæƒ³ï¼">
    <meta property="og:image" content="https://true-ocean.github.io/JRA_Prediction_App/image.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ğŸ ãƒ©ãƒ³ãƒ€ãƒ ãƒ¯ãƒ¼ãƒ‰ã§ç°¡å˜ç«¶é¦¬äºˆæƒ³">
    <meta name="twitter:description" content="å¥½ããªè¨€è‘‰ã‚’ç¨®ã«ã—ã¦ã€è‡ªåˆ†ã ã‘ã®ç°¡å˜ç«¶é¦¬äºˆæƒ³ï¼">
    <meta name="twitter:image" content="https://true-ocean.github.io/JRA_Prediction_App/image.jpg">

    <title>ğŸ ãƒ©ãƒ³ãƒ€ãƒ ãƒ¯ãƒ¼ãƒ‰ã§ç°¡å˜ç«¶é¦¬äºˆæƒ³</title>
    <style>
        :root {
            --theme-color: #27ae60;
            --theme-hover: #219150;
            --accent-color: #27ae60;
            --reset-color: #95a5a6;
            --copy-color: #34495e;
        }
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: #eef2f3; color: #333; padding: 10px; margin: 0; transition: 0.3s; }
        .container { background: white; max-width: 600px; margin: 20px auto; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
        h1 { text-align: center; color: #2c3e50; border-bottom: 2px solid var(--theme-color); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; transition: 0.3s; }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; align-items: stretch;}
        label { font-weight: bold; margin-bottom: 5px; font-size: 0.85em; color: #555; text-align: left;}
        select, input { padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; background: #fff; width: 100%; box-sizing: border-box; -webkit-appearance: none; appearance: none; text-align: left; text-align-last: left; }
        
        /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚„å…¥åŠ›æ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        select:disabled, input:disabled {
            background-color: #f0f0f0; /* å°‘ã—ã‚°ãƒ¬ãƒ¼ã«ã™ã‚‹ */
            color: #999;              /* æ–‡å­—ã‚’è–„ãã™ã‚‹ */
            cursor: not-allowed;      /* ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç¦æ­¢ãƒãƒ¼ã‚¯ã«ã™ã‚‹ */
            border-color: #ddd;       /* æ ç·šã‚’è–„ãã™ã‚‹ */
            opacity: 1;               /* iOSã§ã®é€æ˜åº¦èª¿æ•´ã‚’ç„¡åŠ¹åŒ– */
            -webkit-text-fill-color: #999; /* iOSã§ã®æ–‡å­—è‰²ã‚’å›ºå®š */
        }
        
        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚¹ãƒãƒ›æ™‚ã¯1åˆ—ï¼‰ */
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 5px; }
        @media (max-width: 480px) { .row { grid-template-columns: 1fr; } }

        .word-inputs { display: flex; flex-direction: column; gap: 8px; width: 100%; }

        /* ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆå¹…ã‚’çµ±ä¸€ï¼‰ */
        .button-stack { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        button { width: 100%; padding: 15px; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; box-sizing: border-box; }
        
        .btn-predict { background: var(--theme-color); font-size: 18px; }
        .btn-predict:hover { opacity: 0.9; }
        .btn-reset { background: var(--reset-color); }
        .btn-copy { background: var(--copy-color); display: none; } /* çµæœãŒã‚ã‚‹æ™‚ã ã‘è¡¨ç¤º */
        button:active { transform: scale(0.98); }

        /* äºˆæƒ³çµæœ */
        #result { margin-top: 25px; }
        .prediction-card { border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow: hidden; }

        .prediction-item { 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            padding: 10px 12px 10px 12px; 
            border-bottom: 1px solid #eee;
            min-width: 320px; /* â˜…ã‚¹ãƒãƒ›ã§ã‚‚ç”»åƒåŒ–ã®éš›ã«æ½°ã‚Œãªã„æœ€ä½å¹…ã‚’ç¢ºä¿ */
            box-sizing: border-box;
        }

        .prediction-item:last-child { border-bottom: none; }
        .term { display: none; width: 45px; font-size: 0.75em; color: #7f8c8d; font-weight: bold; flex-shrink: 0; }
        .mark { width: 30px; font-weight: bold; font-size: 1.2em; text-align: center; flex-shrink: 0; }
        .waku-box { width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; margin-left: 10px; flex-shrink: 0; }
        .horse-name { font-weight: bold; font-size: 1em; color: #2c3e50; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .horse-info { margin-left: 10px; display: flex; flex-direction: column; min-width: 0; flex: 1;}
        .jockey-name { font-size: 0.8em; color: #666; margin-top: 2px; }
                
        #errorMessage {
            text-align: center;
            white-space: pre-line;
            font-size: 0.9em;
            
            /* åˆæœŸçŠ¶æ…‹ï¼šå®Œå…¨ã«éš ã™ */
            opacity: 0;
            max-height: 0;
            margin-bottom: 0;
            padding: 0;
            visibility: hidden; /* ã“ã‚Œã§éš™é–“ã‚’æ¶ˆã™ */
            overflow: hidden;
            transition: all 0.5s ease; /* 0.5ç§’ã‹ã‘ã¦å¤‰åŒ– */
        }

        /* ã‚¯ãƒ©ã‚¹ãŒä»˜ã„ãŸæ™‚ã ã‘è¡¨ç¤º */
        #errorMessage.show {
            opacity: 1;
            max-height: 100px; /* å†…å®¹ã«åˆã‚ã›ã¦é©å®œèª¿æ•´ */
            margin-bottom: 15px;
            padding: 12px;
            visibility: visible;
            background-color: #e74c3c;
            color: #fff;
            border-radius: 8px;
            border: 1px solid #c0392b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<body>

<div class="container">

    <h1 id="mainTitle">ğŸ‡ ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ï¼ˆæ±ç”¨ï¼‰</h1>
    
    <p style="text-align: center; font-size: 0.8em; color: #666; line-height: 1.6; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 6px; border-left: 4px solid var(--theme-color);">
        ã‚ãªãŸã ã‘ã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ¯ãƒ¼ãƒ‰ã§ç°¡å˜ç«¶é¦¬äºˆæƒ³ï¼<br>
        âš ï¸ æ±ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã¯é¦¬ç•ªã®ã¿ã®å‡ºåŠ›ã«ãªã‚Šã¾ã™
    </p>

    <div class="form-group">
        <label>ãƒ¬ãƒ¼ã‚¹é¸æŠ</label>
        <select id="raceSelector" onchange="applySelectedRace()">
            <option value="-1">æ±ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼šè‡ªåˆ†ã§æ¡ä»¶é¸æŠ</option>
            </select>
    </div>

    <div class="form-group">
        <label>é–‹å‚¬æ—¥</label>
        <input type="date" id="raceDate" onchange="checkRaceMode()">
    </div>

    <div class="row">
        <div class="form-group"><label>ç«¶é¦¬å ´</label>
            <select id="venue" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option>æœ­å¹Œ</option><option>å‡½é¤¨</option><option>æ–°æ½Ÿ</option><option>ç¦å³¶</option>
                <option selected>æ±äº¬</option><option>ä¸­å±±</option><option>ä¸­äº¬</option><option>äº¬éƒ½</option>
                <option>é˜ªç¥</option><option>å°å€‰</option>
            </select>
        </div>
        <div class="form-group"><label>ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
            <select id="raceNum" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <script>for(let i=1;i<=12;i++){ const sel = (i===11?'selected':''); document.write(`<option value="${i}R" ${sel}>${i}R</option>`); }</script>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group"><label>å¹´é½¢é™å®š</label>
            <select id="ageLimit" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option>2æ­³</option><option>3æ­³</option><option>3æ­³ä»¥ä¸Š</option><option selected>4æ­³ä»¥ä¸Š</option>
            </select>
        </div>
        <div class="form-group"><label>ã‚¯ãƒ©ã‚¹</label>
            <select id="raceClass" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option selected>G1</option><option>G2</option><option>G3</option><option>OP(L)</option>
                <option>ã‚ªãƒ¼ãƒ—ãƒ³</option><option>3å‹ã‚¯ãƒ©ã‚¹</option><option>2å‹ã‚¯ãƒ©ã‚¹</option>
                <option>1å‹ã‚¯ãƒ©ã‚¹</option><option>æœªå‹åˆ©</option><option>æ–°é¦¬</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group"><label>ãƒˆãƒ©ãƒƒã‚¯</label>
            <select id="track" onchange="updateTheme(); checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option value="èŠ">èŠ</option>
                <option value="ãƒ€ãƒ¼ãƒˆ" selected>ãƒ€ãƒ¼ãƒˆ</option>
            </select>
        </div>
        <div class="form-group"><label>è·é›¢</label>
            <select id="distance" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <script>
                    const dists = ['1000','1150','1200','1300','1400','1500','1600','1700','1800','1900','2000','2100','2200','2300','2400','2500','2600','3000','3200','3400','3600'];
                    dists.forEach(d => {
                        const sel = (d === '1600' ? 'selected' : '');
                        document.write(`<option value="${d}" ${sel}>${d}m</option>`);
                    });
                </script>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="form-group"><label>é‡é‡</label>
            <select id="weightType" onchange="checkRaceMode(); validateInputs()">
                <option value="">-- é¸æŠ --</option>
                <option selected>å®šé‡</option><option>åˆ¥å®š</option><option>é¦¬é½¢</option><option>ãƒãƒ³ãƒ‡</option>
            </select>
        </div>
        <div class="form-group"><label>é¦¬å ´çŠ¶æ…‹</label>
            <select id="condition" onchange="validateInputs()">
                <option value="" selected>-- é¸æŠ --</option>
                <option>è‰¯</option><option>ç¨é‡</option><option>é‡</option><option>ä¸è‰¯</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>å‡ºèµ°é ­æ•°</label>
        <select id="horseCount" onchange="checkRaceMode(); validateInputs()">
            <option value="">-- é¸æŠ --</option>
            <script>
                for(let i=5; i<=18; i++) {
                    const selected = i === 16 ? 'selected' : '';
                    document.write(`<option value="${i}" ${selected}>${i}é ­</option>`);
                }
            </script>
        </select>
    </div>

    <div class="form-group">
        <label>ãŠå¥½ã¿ã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ¯ãƒ¼ãƒ‰ï¼ˆæœ€å¤§3ã¤ï¼‰</label>
        <div class="word-inputs">
            <input type="text" id="word1" placeholder="ãƒ¯ãƒ¼ãƒ‰1" oninput="validateInputs()">
            <input type="text" id="word2" placeholder="ãƒ¯ãƒ¼ãƒ‰2" oninput="validateInputs()">
            <input type="text" id="word3" placeholder="ãƒ¯ãƒ¼ãƒ‰3" oninput="validateInputs()">
        </div>
    </div>

    <div id="errorMessage"></div>

    <div class="button-stack">
        <button class="btn-predict" onclick="generatePrediction()">äºˆæƒ³ã‚’ç®—å‡ºã™ã‚‹</button>
        <button class="btn-reset" id="resetBtn" onclick="resetToDefault()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="result"></div>

    <div class="button-stack">
        <button class="btn-save" id="saveBtn" onclick="saveAsImage()" style="background: #FF77FF; display: none;">äºˆæƒ³çµæœã‚’ç”»åƒã§ä¿å­˜ãƒ»å…±æœ‰</button>
        <button class="btn-x" id="xBtn" onclick="postToX()" style="background: #000; display: none;">äºˆæƒ³çµæœã‚’ X ã«ãƒã‚¹ãƒˆï¼ˆç”»åƒãªã—ï¼‰</button>
        <button class="btn-copy" id="copyBtn" onclick="copyResult()">äºˆæƒ³çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
    </div>

    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 0.7em; line-height: 1.5;">
        <p style="margin-bottom: 10px;">
            Disclaimer: This application is for informational purposes only. It does not provide financial or betting advice. Users are responsible for their own decisions.<br>
            å…è²¬äº‹é …ï¼šæœ¬ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¯æƒ…å ±æä¾›ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€é‡‘èã¾ãŸã¯è³­åšã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åˆ©ç”¨è€…ã¯è‡ªå·±ã®åˆ¤æ–­ã«åŸºã¥ã„ã¦è¡Œå‹•ã™ã‚‹è²¬ä»»ãŒã‚ã‚Šã¾ã™ã€‚
        </p>
        <p style="text-align: center; font-weight: bold;">
            Created by <a href="#" style="color: #666; text-decoration: none;">ã‚·ãƒ£ãƒãƒ¯ãƒ¼ãƒ«</a>. All rights reserved.
        </p>
    </footer>

</div>

<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center; flex-direction:column; padding: 20px;">
    <p style="color:white; margin-bottom:15px; font-weight:bold; text-align:center;">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦<br>ã€Œ"å†™çœŸ"ã«ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <img id="previewImage" style="max-width:100%; max-height:70%; border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
    <button onclick="document.getElementById('imageModal').style.display='none'" style="margin-top:25px; background:#fff; color:#333; width:auto; padding:12px 40px; border-radius:30px;">é–‰ã˜ã‚‹</button>
</div>

<script>
// ==========================================
// ã€ãƒ¬ãƒ¼ã‚¹è¨­å®šãƒªã‚¹ãƒˆã€‘
// ==========================================
const RACE_LIST = [
    {
        raceDate: "2026-02-22",
        title: "ãƒ•ã‚§ãƒ–ãƒ©ãƒªãƒ¼S",
        venue: "æ±äº¬",
        raceNum: "11R",
        track: "ãƒ€ãƒ¼ãƒˆ",
        distance: "1600",
        ageLimit: "4æ­³ä»¥ä¸Š",
        raceClass: "G1",
        weightType: "å®šé‡",
        horseCount: 16,
        horses: [
            { name: "ã‚ªãƒ¡ã‚¬ã‚®ãƒã‚¹", info: "ç‰¡6", jockey: "å²©ç”°åº·èª " },
            { name: "ãƒãƒƒãƒ”ãƒ¼ãƒãƒ³", info: "ç‰¡4", jockey: "é«˜æ‰åéº’" },
            { name: "ãƒ–ãƒ©ã‚¤ã‚¢ãƒ³ã‚»ãƒ³ã‚¹", info: "ç‰¡6", jockey: "å²©ç”°æœ›æ¥" },
            { name: "ãƒšãƒªã‚¨ãƒ¼ãƒ«", info: "ç‰¡6", jockey: "ä½ã€…æœ¨å¤§" },
            { name: "ã‚·ãƒƒã‚¯ã‚¹ãƒšãƒ³ã‚¹", info: "ç‰¡5", jockey: "æˆ¸å´åœ­å¤ª" },
            { name: "ãƒ©ãƒ ã‚¸ã‚§ãƒƒãƒˆ", info: "ç‰¡5", jockey: "ä¸‰æµ¦çš‡æˆ" },
            { name: "ãƒ­ãƒ³ã‚°ãƒ©ãƒ³", info: "ã‚»8", jockey: "è»é‡æ¥µ" },
            { name: "ã‚µã‚¯ãƒ©ãƒˆã‚¥ã‚¸ãƒ¥ãƒ¼ãƒ«", info: "ã‚»9", jockey: "ã‚­ãƒ³ã‚°" },
            { name: "ãƒ€ãƒ–ãƒ«ãƒãƒ¼ãƒˆãƒœãƒ³ãƒ‰", info: "ç‰5", jockey: "å‚äº•ç‘ æ˜Ÿ" },
            { name: "ãƒ­ãƒ¼ãƒ‰ã‚¯ãƒ­ãƒ³ãƒŒ", info: "ç‰¡5", jockey: "æ©«å±±å’Œç”Ÿ" },
            { name: "ã‚µãƒ³ãƒ©ã‚¤ã‚ºãƒ›ãƒ¼ã‚¯", info: "ã‚»7", jockey: "æ¾å²¡æ­£æµ·" },
            { name: "ã‚³ã‚¹ã‚¿ãƒãƒ´ã‚¡", info: "ç‰¡6", jockey: "ãƒ«ãƒ¡ãƒ¼ãƒ«" },
            { name: "ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒ©ã‚¤ã‚º", info: "ç‰¡4", jockey: "æ©«å±±æ­¦å²" },
            { name: "ã‚¦ã‚£ãƒ«ã‚½ãƒ³ãƒ†ã‚½ãƒ¼ãƒ­", info: "ç‰¡7", jockey: "å·ç”°å°†é›…" },
            { name: "ãƒšãƒ—ãƒãƒ‰ãƒŠã‚¤ãƒ«", info: "ç‰¡8", jockey: "å¯Œç”°æš" },
            { name: "ã‚µã‚¤ãƒ¢ãƒ³ã‚¶ãƒŠãƒ‰ã‚¥", info: "ç‰¡6", jockey: "æ± æ·»è¬™ä¸€" }
        ]
    },
    {
        raceDate: "2026-02-22",
        title: "å°å€‰å¤§è³å…¸",
        venue: "å°å€‰",
        raceNum: "11R",
        track: "èŠ",
        distance: "1800",
        ageLimit: "4æ­³ä»¥ä¸Š",
        raceClass: "G3",
        weightType: "ãƒãƒ³ãƒ‡",
        horseCount: 16,
        horses: [
            { name: "ãƒãƒ†ãƒ³ãƒ­ã‚¦ã‚ªãƒªã‚ªãƒ³", info: "ç‰¡7", jockey: "æ©«å±±å…¸å¼˜" },
            { name: "ãƒ“ãƒ¼ã‚¢ã‚¹ãƒˆãƒ‹ãƒƒã‚·ãƒ‰", info: "ç‰¡7", jockey: "è¥¿æ‘å¤ªä¸€" },
            { name: "ã‚¨ã‚¢ãƒ•ã‚¡ãƒ³ãƒ‡ã‚£ã‚¿", info: "ã‚»9", jockey: "äº€ç”°æ¸©å¿ƒ" },
            { name: "ã‚·ãƒ§ã‚¦ãƒŠãƒ³ã‚¢ãƒ‡ã‚¤ãƒ–", info: "ç‰¡7", jockey: "ä¸¸å±±å…ƒæ°—" },
            { name: "ãƒ˜ãƒªã‚ªã‚¹", info: "ã‚»10", jockey: "èŠæ²¢ä¸€æ¨¹" },
            { name: "ãƒãƒ¬ãƒ", info: "ç‰5", jockey: "é®«å³¶å…‹é§¿" },
            { name: "ã‚·ãƒ«ãƒˆãƒ›ãƒ«ãƒ³", info: "ç‰¡6", jockey: "çŸ³ç”°æ‹“éƒ" },
            { name: "ãƒ©ã‚±ãƒ¼ãƒãƒ€", info: "ç‰¡6", jockey: "ä¸¹å†…ç¥æ¬¡" },
            { name: "ãƒŠãƒ ãƒ©ã‚¨ã‚¤ãƒãƒ–", info: "ç‰¡5", jockey: "å‰ç”°éš¼äºº" },
            { name: "ã‚±ã‚¤ã‚¢ã‚¤ã‚»ãƒŠ", info: "ç‰¡7", jockey: "è—¤å²¡ä½‘ä»‹" },
            { name: "ã‚¨ãƒ”ãƒ•ã‚¡ãƒ‹ãƒ¼", info: "ç‰¡7", jockey: "æ‰åŸèª äºº" },
            { name: "ã‚»ãƒ³ãƒ„ãƒ–ãƒ©ã‚¤ãƒˆ", info: "ç‰¡4", jockey: "å›£é‡å¤§æˆ" },
            { name: "ã‚¬ã‚¤ã‚¢ãƒ¡ãƒ³ãƒ†", info: "ç‰¡5", jockey: "åŒ—æ‘å‹ä¸€" },
            { name: "ã‚¨ãƒ©ãƒˆãƒ¼", info: "ç‰5", jockey: "æ–è—¤æ–°" },
            { name: "ãƒªã‚«ãƒ³ã‚«ãƒ–ãƒ¼ãƒ«", info: "ã‚»7", jockey: "æµœä¸­ä¿Š" },
            { name: "ã‚¿ã‚¬ãƒãƒ‡ãƒ¥ãƒ¼ãƒ‰", info: "ç‰¡5", jockey: "å¤å·å‰æ´‹" }
        ]
    }
];

let isRace = false;
let currentActiveRace = null; // ç¾åœ¨é¸æŠãƒ»ä¸€è‡´ã—ã¦ã„ã‚‹ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿
let currentPredictionText = "";

window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('raceDate').value = today;

    const selector = document.getElementById('raceSelector');
    RACE_LIST.forEach((race, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.innerText = race.title;
        selector.appendChild(opt);
    });

    selector.value = "-1"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œè‡ªåˆ†ã§è¨­å®šã™ã‚‹ã€
    applySelectedRace("-1");
};

// å…¥åŠ›é …ç›®ã®æœ‰åŠ¹ãƒ»ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
function toggleInputsDisabled(isDisabled) {
    const targetIds = [
        'raceDate', 'venue', 'raceNum', 'ageLimit', 
        'raceClass', 'track', 'distance', 'weightType', 'horseCount'
    ];
    
    targetIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = isDisabled;
    });
}

// é¸æŠã•ã‚ŒãŸãƒ¬ãƒ¼ã‚¹ã®æƒ…å ±ã‚’å…¥åŠ›æ¬„ã«åæ˜ ã™ã‚‹
function applySelectedRace(forcedIndex = null) {
    const selector = document.getElementById('raceSelector');
    const index = forcedIndex !== null ? forcedIndex : selector.value;
    
    // ãƒ¬ãƒ¼ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆãŸã‚‰ã€ä»¥å‰ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’æ¶ˆã™
    const errorEl = document.getElementById('errorMessage');
    if (errorEl) {
        errorEl.classList.remove('show');
    }

    // --- ã€Œè‡ªåˆ†ã§è¨­å®šã™ã‚‹ã€ã‚’é¸ã‚“ã å ´åˆã®å‡¦ç† ---
    if (index === "-1") {
        // å…¥åŠ›ã‚’æœ‰åŠ¹ã«ã—ã¦ã€å…¨ã¦ã®å…¥åŠ›ã‚’åˆæœŸåŒ–ãƒ»ã‚¯ãƒªã‚¢ã™ã‚‹
        toggleInputsDisabled(false);
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('raceDate').value = today; // æ—¥ä»˜ã¯ä»Šæ—¥ã«ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('venue').value = "";
        document.getElementById('raceNum').value = "";
        document.getElementById('ageLimit').value = "";
        document.getElementById('raceClass').value = "";
        document.getElementById('track').value = "";
        document.getElementById('distance').value = "";
        document.getElementById('weightType').value = "";
        document.getElementById('condition').value = "";
        document.getElementById('horseCount').value = "";
        
        // ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã‚‚ç©ºã«ã™ã‚‹
        document.getElementById('word1').value = "";
        document.getElementById('word2').value = "";
        document.getElementById('word3').value = "";

        updateTheme(); // ãƒ†ãƒ¼ãƒè‰²ï¼ˆèŠ/ãƒ€ãƒ¼ãƒˆï¼‰ã‚’åæ˜ 
        checkRaceMode(); // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã€Œæ±ç”¨ã€ã¸åˆ‡ã‚Šæ›¿ãˆ
        return;
    }
    
    // --- ç‰¹å®šã®ãƒ¬ãƒ¼ã‚¹ã‚’é¸ã‚“ã å ´åˆã®å‡¦ç† ---
    toggleInputsDisabled(true); // â˜…å…¥åŠ›ã‚’ç„¡åŠ¹ã«ã™ã‚‹
    const race = RACE_LIST[index];
    document.getElementById('raceDate').value = race.raceDate;
    document.getElementById('venue').value = race.venue;
    document.getElementById('raceNum').value = race.raceNum;
    document.getElementById('ageLimit').value = race.ageLimit;
    document.getElementById('raceClass').value = race.raceClass;
    document.getElementById('track').value = race.track;
    document.getElementById('distance').value = race.distance;
    document.getElementById('weightType').value = race.weightType;
    document.getElementById('condition').value = "";
    document.getElementById('horseCount').value = race.horseCount;

    document.getElementById('word1').value = "";
    document.getElementById('word2').value = "";
    document.getElementById('word3').value = "";
    
    updateTheme();
    checkRaceMode();
    document.getElementById('resetBtn').innerText = `ãƒªã‚»ãƒƒãƒˆï¼ˆ${race.title}ï¼‰`;
}

function checkRaceMode() {
    const raceDate = document.getElementById('raceDate').value;
    const venue = document.getElementById('venue').value;
    const raceNum = document.getElementById('raceNum').value;
    const track = document.getElementById('track').value;
    const distance = document.getElementById('distance').value;
    const weight = document.getElementById('weightType').value;
    const count = document.getElementById('horseCount').value;

    const foundRace = RACE_LIST.find(race => 
        race.raceDate === raceDate && 
        race.venue === venue && 
        race.raceNum === raceNum &&
        race.track === track &&
        race.distance === distance &&
        parseInt(count) === race.horseCount
    );

    const resetBtn = document.getElementById('resetBtn'); // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’å–å¾—

    if (foundRace) {
        isRace = true;
        currentActiveRace = foundRace;
        document.getElementById('mainTitle').innerText = `ğŸ† ${foundRace.title}`;
        resetBtn.style.display = "none"; // ãƒ¬ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
    } else {
        isRace = false;
        currentActiveRace = null;
        document.getElementById('mainTitle').innerText = "ğŸ‡ ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ï¼ˆæ±ç”¨ï¼‰";
        // æ±ç”¨ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã ã‘ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
        resetBtn.style.display = "block";
        resetBtn.innerText = "ãƒªã‚»ãƒƒãƒˆ";
    }
    
    document.getElementById('copyBtn').style.display = "none";
    document.getElementById('xBtn').style.display = "none";
    document.getElementById('saveBtn').style.display = "none"; 
    document.getElementById('result').innerHTML = "";
}

function resetToDefault() {
    const selector = document.getElementById('raceSelector');
    const index = selector.value;
    
    if (index !== "-1") {
        applySelectedRace(index);
    } else {
        document.getElementById('word1').value = "";
        document.getElementById('word2').value = "";
        document.getElementById('word3').value = "";
        checkRaceMode();
    }
}

function updateTheme() {
    const track = document.getElementById('track').value;
    const root = document.documentElement;
    
    // ãƒ€ãƒ¼ãƒˆãŒé¸ã°ã‚Œã¦ã„ã‚‹æ™‚ã ã‘èŒ¶è‰²ã€ãã‚Œä»¥å¤–ï¼ˆèŠ or æœªé¸æŠï¼‰ã¯ç·‘
    if (track === "ãƒ€ãƒ¼ãƒˆ") {
        root.style.setProperty('--theme-color', '#a67c52');
        root.style.setProperty('--theme-hover', '#8c6543');
    } else {
        root.style.setProperty('--theme-color', '#27ae60');
        root.style.setProperty('--theme-hover', '#219150');
    }
}

// å…¥åŠ›ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†é–¢æ•°
function validateInputs() {
    const venue = document.getElementById('venue').value;
    const raceNum = document.getElementById('raceNum').value;
    const ageLimit = document.getElementById('ageLimit').value;
    const raceClass = document.getElementById('raceClass').value;
    const track = document.getElementById('track').value;
    const distance = document.getElementById('distance').value;
    const weightType = document.getElementById('weightType').value;
    const horseCount = document.getElementById('horseCount').value;
    const condition = document.getElementById('condition').value;
    const w1 = document.getElementById('word1').value;
    const w2 = document.getElementById('word2').value;
    const w3 = document.getElementById('word3').value;

    const errorEl = document.getElementById('errorMessage');

    // åˆ¤å®šç”¨ãƒ•ãƒ©ã‚°
    const isRaceConfigOk = venue && raceNum && ageLimit && raceClass && track && distance && weightType && horseCount && condition;
    const isWordOk = w1 || w2 || w3;

    if (isRaceConfigOk && isWordOk) {
        // å…¨ã¦OKãªã‚‰æ¶ˆã™
        errorEl.classList.remove('show');
        setTimeout(() => { if(!errorEl.classList.contains('show')) errorEl.innerText = ""; }, 500);
        return true;
    } else if (isRaceConfigOk && !isWordOk) {
        // ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã¯æƒã£ãŸãŒã€ãƒ¯ãƒ¼ãƒ‰ãŒã¾ã ã®å ´åˆ
        // ã™ã§ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã‚‹çŠ¶æ…‹ãªã‚‰ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã€Œãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã€ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
        if (errorEl.classList.contains('show')) {
            errorEl.innerText = "ã‚¨ãƒ©ãƒ¼ï¼šæœ€ä½1ã¤ã€ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼\nãã®ãƒ¯ãƒ¼ãƒ‰ãŒäºˆæƒ³ã®ç¨®ã«ãªã‚‹ã‚ˆï¼";
        }
    } else if (!isRaceConfigOk) {
        // ã¾ã ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ãŒæƒã£ã¦ã„ãªã„å ´åˆ
        // ï¼ˆã“ã“ã¯ç¾çŠ¶ç¶­æŒã€‚ã‚‚ã—ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºä¸­ãªã‚‰ã€Œæœªé¸æŠé …ç›®ã‚ã‚Šã€ã®ã¾ã¾ã«ã™ã‚‹ï¼‰
        if (errorEl.classList.contains('show')) {
            errorEl.innerText = "ã‚¨ãƒ©ãƒ¼ï¼šæœªé¸æŠã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚";
        }
    }
    
    return false;
}

function generatePrediction() {
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨è¦ç´ ã‚’å–å¾—
    const errorEl = document.getElementById('errorMessage');

    // å†…éƒ¨ç”¨ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°ï¼ˆå®šç¾©ã‚’å…ˆé ­ã«æŒã£ã¦ãã‚‹ï¼‰
    const showError = (message) => {
        errorEl.innerText = message;
        errorEl.classList.add('show');
        errorEl.scrollIntoView({behavior: 'smooth', block: 'center'});
    };

    // 1. ä½œæˆæ¸ˆã¿ã® validateInputs ã‚’å‘¼ã³å‡ºã™
    const isValid = validateInputs();

    // 2. å…¥åŠ›ä¸è¶³ãŒã‚ã‚‹å ´åˆã¯ã€å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
    if (!isValid) {
        const venue = document.getElementById('venue').value;
        const raceNum = document.getElementById('raceNum').value;
        const ageLimit = document.getElementById('ageLimit').value;
        const raceClass = document.getElementById('raceClass').value;
        const track = document.getElementById('track').value;
        const distance = document.getElementById('distance').value;
        const weightType = document.getElementById('weightType').value;
        const horseCount = document.getElementById('horseCount').value;
        const condition = document.getElementById('condition').value;
        const w1 = document.getElementById('word1').value;
        const w2 = document.getElementById('word2').value;
        const w3 = document.getElementById('word3').value;

        if (!venue || !raceNum || !ageLimit || !raceClass || !track || !distance || !weightType || !horseCount || !condition) {
            showError("ã‚¨ãƒ©ãƒ¼ï¼šæœªé¸æŠã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚");
        }
        else if (!w1 && !w2 && !w3) { 
            showError("ã‚¨ãƒ©ãƒ¼ï¼šæœ€ä½1ã¤ã€ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼\nãã®ãƒ¯ãƒ¼ãƒ‰ãŒäºˆæƒ³ã®ç¨®ã«ãªã‚‹ã‚ˆï¼");
        }
        return; // è¨ˆç®—ã‚’ä¸­æ­¢
    }

    // --- 3. ã“ã“ã‹ã‚‰ã¯ã€Œå…¥åŠ›ãŒå®Œç’§ãªå ´åˆã€ã®å‡¦ç† ---

    // å…¥åŠ›å€¤ã®å†å–å¾—ï¼ˆè¨ˆç®—ç”¨ï¼‰
    const date = document.getElementById('raceDate').value;
    const venue = document.getElementById('venue').value;
    const raceNum = document.getElementById('raceNum').value;
    const track = document.getElementById('track').value;
    const w1 = document.getElementById('word1').value;
    const w2 = document.getElementById('word2').value;
    const w3 = document.getElementById('word3').value;
    const horseCount = document.getElementById('horseCount').value;
    const count = parseInt(horseCount);

    // ã‚·ãƒ¼ãƒ‰å€¤ã®è¨ˆç®—
    let seed = 0;
    const combined = date + venue + raceNum + 
                     document.getElementById('ageLimit').value + 
                     document.getElementById('raceClass').value + 
                     document.getElementById('track').value + 
                     document.getElementById('distance').value + 
                     document.getElementById('weightType').value + 
                     document.getElementById('condition').value + w1 + w2 + w3;

    for (let i = 0; i < combined.length; i++) {
        seed = (seed + combined.charCodeAt(i) * (i + 1)) % 1000000;
    }

    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ­ã‚¸ãƒƒã‚¯
    let horses = Array.from({length: count}, (_, i) => i + 1);
    for (let i = horses.length - 1; i > 0; i--) {
        seed = (seed * 9301 + 49297) % 233280;
        const j = Math.floor((seed / 233280) * (i + 1));
        [horses[i], horses[j]] = [horses[j], horses[i]];
    }

    // çµæœè¡¨ç¤ºã®æ§‹ç¯‰
    const marks = [
        {t: "æœ¬å‘½", s: "â—"}, {t: "å¯¾æŠ—", s: "â—¯"},
        {t: "å˜ç©´", s: "â–²"}, {t: "é€£ä¸‹", s: "â–³"}, {t: "æ˜Ÿ", s: "â­ï¸"}
    ];

    let html = "<h3>äºˆæƒ³çµæœ</h3><div class='prediction-card'>";
    let copyText = `ã€${document.getElementById('mainTitle').innerText}ã€‘\n`;
    copyText += `${date} ${venue}${raceNum}\n\n`;

    let usedWords = [w1, w2, w3].filter(w => w !== "").join("\n");
    if (usedWords) {
        copyText += `å…¥åŠ›ãƒ¯ãƒ¼ãƒ‰ï¼š\n${usedWords}\n`;
    }
    copyText += `\n`;

    for(let i = 0; i < 5; i++) {
        if (i >= count) break;
        const horseNum = horses[i];
        const waku = getWakuInfo(horseNum, count);
        let infoHtml = "";
        let lineText = `${marks[i].s} ${horseNum}`;

        if (isRace && currentActiveRace) {
            const horse = currentActiveRace.horses[horseNum - 1] || { name: horseNum + "ç•ª", info: "", jockey: "" };
            infoHtml = `
                <div class="horse-info">
                    <div class="horse-name">${horse.name}ï¼ˆ${horse.info}ï¼‰</div>
                    <div class="jockey-name">${horse.jockey}</div>
                </div>`;
            lineText += ` ${horse.name}`;
        }

        html += `
            <div class="prediction-item">
                <div class="mark">${marks[i].s}</div>
                <div class="waku-box" style="background:${waku.bg}; color:${waku.txt}">${horseNum}</div>
                ${infoHtml}
            </div>`;
        copyText += lineText + "\n";
    }
    
    document.getElementById('result').innerHTML = html + "</div>";
    currentPredictionText = copyText + "\n#ãƒ©ãƒ³ãƒ€ãƒ ãƒ¯ãƒ¼ãƒ‰ã§ç°¡å˜ç«¶é¦¬äºˆæƒ³";
    document.getElementById('saveBtn').style.display = "block";
    document.getElementById('xBtn').style.display = "block";
    document.getElementById('copyBtn').style.display = "block";
}

async function saveAsImage() {
    // äºˆæƒ³çµæœã®ã‚«ãƒ¼ãƒ‰éƒ¨åˆ†ï¼ˆç™½ã„ãƒœãƒƒã‚¯ã‚¹ï¼‰ã ã‘ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹
    const target = document.querySelector("#result .prediction-card");
    if (!target) return;

    try {
        // html2canvasãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆã‚«ãƒ¼ãƒ‰éƒ¨åˆ†ï¼‰ã®ã‚µã‚¤ã‚ºã‚’è‡ªå‹•èªè­˜ã—ã¦åˆ‡ã‚ŠæŠœãã¾ã™
        const canvas = await html2canvas(target, {
            scale: 2, // é®®æ˜ã«ä¿å­˜ã™ã‚‹ãŸã‚ã®å€ç‡
            backgroundColor: "#ffffff", // èƒŒæ™¯ã‚’ç™½ã§å›ºå®š
            logging: false,
            // ç”»é¢ä¸Šã®è¦‹ãŸç›®ï¼ˆå¹…ï¼‰ã‚’ãã®ã¾ã¾ç¶­æŒã™ã‚‹è¨­å®š
            width: target.offsetWidth,
            height: target.offsetHeight,
            scrollX: 0,
            scrollY: -window.scrollY, // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã«ã‚ˆã‚‹ã‚ºãƒ¬ã‚’é˜²æ­¢
            useCORS: true
        });

        // Canvasã‚’ãƒ•ã‚¡ã‚¤ãƒ«åŒ–
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const file = new File([blob], `prediction_${new Date().getTime()}.png`, { type: 'image/png' });

        // å…±æœ‰ãƒ»ä¿å­˜å‡¦ç†
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
                files: [file],
                title: 'ç«¶é¦¬äºˆæƒ³çµæœ',
                text: currentPredictionText
            });
        } else {
            handleFallbackSave(canvas.toDataURL("image/png"));
        }
    } catch (error) {
        console.error("Error sharing:", error);
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå…±æœ‰æ©Ÿèƒ½ãŒãªã„ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰
function handleFallbackSave(imageData) {
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
        const modal = document.getElementById('imageModal');
        const previewImg = document.getElementById('previewImage');
        previewImg.src = imageData;
        modal.style.display = 'flex';
    } else {
        const link = document.createElement("a");
        link.download = `prediction_${new Date().getTime()}.png`;
        link.href = imageData;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function postToX() {
    const text = encodeURIComponent(currentPredictionText);
    const url = `https://twitter.com/intent/tweet?text=${text}`;
    window.open(url, '_blank');
}

function copyResult() {
    navigator.clipboard.writeText(currentPredictionText).then(() => {
        alert("äºˆæƒ³çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼SNSç­‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
    }).catch(err => {
        alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    });
}

function getWakuInfo(num, total) {
    const colors = [{bg:"#fff",txt:"#333"},{bg:"#333",txt:"#fff"},{bg:"#e74c3c",txt:"#fff"},{bg:"#3498db",txt:"#fff"},{bg:"#f1c40f",txt:"#333"},{bg:"#27ae60",txt:"#fff"},{bg:"#e67e22",txt:"#fff"},{bg:"#ff9ff3",txt:"#333"}];
    let w = 1;
    if (total <= 8) w = num;
    else {
        const b = Math.floor(total / 8), r = total % 8;
        let cur = 0;
        for(let i=1; i<=8; i++) {
            cur += (b + (i > (8 - r) ? 1 : 0));
            if(num <= cur) { w = i; break; }
        }
    }
    return colors[w-1];
}
</script>
</body>
</html>